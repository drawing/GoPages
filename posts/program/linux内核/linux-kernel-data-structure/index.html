<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="å†…æ ¸é“¾è¡¨ Linuxå†…æ ¸æœ‰ä¸€äº›åŸºæœ¬çš„æ•°æ®ç»“æ„ï¼Œè¿™äº›æ•°æ®ç»“æ„æ˜¯Linuxå®ç°çš„åŸºç¡€ï¼Œå¯¹äºé“¾è¡¨ç›¸ä¿¡å¤§å®¶éƒ½ä¸é™Œç”Ÿï¼Œä½†æ˜¯Linuxå†…æ ¸ä¸­çš„é“¾è¡¨ä¸å¹³å¸¸å¹³å¸¸æˆ‘ä»¬æ‰€ä½¿ç”¨çš„é“¾è¡¨ç•¥æœ‰ä¸åŒï¼Œç¬¬ä¸€æ¬¡é‡åˆ°æˆ–è®¸ä¼šæ„Ÿåˆ°å›°æƒ‘ã€‚\n">
<title>Linuxå†…æ ¸æ•°æ®ç»“æ„</title>

<link rel='canonical' href='https://drawing.fancymore.com/posts/program/linux%E5%86%85%E6%A0%B8/linux-kernel-data-structure/'>

<link rel="stylesheet" href="/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css"><meta property='og:title' content="Linuxå†…æ ¸æ•°æ®ç»“æ„">
<meta property='og:description' content="å†…æ ¸é“¾è¡¨ Linuxå†…æ ¸æœ‰ä¸€äº›åŸºæœ¬çš„æ•°æ®ç»“æ„ï¼Œè¿™äº›æ•°æ®ç»“æ„æ˜¯Linuxå®ç°çš„åŸºç¡€ï¼Œå¯¹äºé“¾è¡¨ç›¸ä¿¡å¤§å®¶éƒ½ä¸é™Œç”Ÿï¼Œä½†æ˜¯Linuxå†…æ ¸ä¸­çš„é“¾è¡¨ä¸å¹³å¸¸å¹³å¸¸æˆ‘ä»¬æ‰€ä½¿ç”¨çš„é“¾è¡¨ç•¥æœ‰ä¸åŒï¼Œç¬¬ä¸€æ¬¡é‡åˆ°æˆ–è®¸ä¼šæ„Ÿåˆ°å›°æƒ‘ã€‚\n">
<meta property='og:url' content='https://drawing.fancymore.com/posts/program/linux%E5%86%85%E6%A0%B8/linux-kernel-data-structure/'>
<meta property='og:site_name' content='æ¶¸æ³½ä¹‹é±¼'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts' /><meta property='article:tag' content='Linuxå†…æ ¸' /><meta property='article:published_time' content='2014-05-17T01:16:33&#43;08:00'/><meta property='article:modified_time' content='2014-05-17T01:16:33&#43;08:00'/>
<meta name="twitter:title" content="Linuxå†…æ ¸æ•°æ®ç»“æ„">
<meta name="twitter:description" content="å†…æ ¸é“¾è¡¨ Linuxå†…æ ¸æœ‰ä¸€äº›åŸºæœ¬çš„æ•°æ®ç»“æ„ï¼Œè¿™äº›æ•°æ®ç»“æ„æ˜¯Linuxå®ç°çš„åŸºç¡€ï¼Œå¯¹äºé“¾è¡¨ç›¸ä¿¡å¤§å®¶éƒ½ä¸é™Œç”Ÿï¼Œä½†æ˜¯Linuxå†…æ ¸ä¸­çš„é“¾è¡¨ä¸å¹³å¸¸å¹³å¸¸æˆ‘ä»¬æ‰€ä½¿ç”¨çš„é“¾è¡¨ç•¥æœ‰ä¸åŒï¼Œç¬¬ä¸€æ¬¡é‡åˆ°æˆ–è®¸ä¼šæ„Ÿåˆ°å›°æƒ‘ã€‚\n">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/images/avatar_hu_50b065d24a9bf4d8.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ“–</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">æ¶¸æ³½ä¹‹é±¼</a></h1>
            <h2 class="site-description">æ¶¸æ³½ä¹‹é±¼ï¼ŒçŠ¹å¸Œå‡æ°´ã€‚</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/drawing/'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#æ¦‚è§ˆ">æ¦‚è§ˆ</a></li>
    <li><a href="#åˆå§‹åŒ–é“¾è¡¨">åˆå§‹åŒ–é“¾è¡¨</a></li>
    <li><a href="#æ’å…¥èŠ‚ç‚¹">æ’å…¥èŠ‚ç‚¹</a></li>
    <li><a href="#åˆ é™¤èŠ‚ç‚¹">åˆ é™¤èŠ‚ç‚¹</a></li>
    <li><a href="#æ£€æŸ¥æ˜¯å¦ç©ºé“¾è¡¨">æ£€æŸ¥æ˜¯å¦ç©ºé“¾è¡¨</a></li>
    <li><a href="#éå†é“¾è¡¨">éå†é“¾è¡¨</a></li>
    <li><a href="#å®ä¾‹">å®ä¾‹</a></li>
  </ul>

  <ul>
    <li><a href="#å®šä¹‰">å®šä¹‰</a></li>
    <li><a href="#åŸºæœ¬æ“ä½œ">åŸºæœ¬æ“ä½œ</a></li>
    <li><a href="#å®ä¾‹-1">å®ä¾‹</a></li>
  </ul>

  <ul>
    <li><a href="#å®šä¹‰-1">å®šä¹‰</a></li>
    <li><a href="#å®ç°">å®ç°</a></li>
    <li><a href="#åˆå§‹åŒ–">åˆå§‹åŒ–</a></li>
    <li><a href="#å¢åˆ æ“ä½œ">å¢åˆ æ“ä½œ</a></li>
    <li><a href="#ä¾‹å­">ä¾‹å­</a></li>
  </ul>

  <ul>
    <li><a href="#å®šä¹‰-2">å®šä¹‰</a></li>
    <li><a href="#å®ç°-1">å®ç°</a></li>
  </ul>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E7%BC%96%E7%A8%8B/" >
                ç¼–ç¨‹
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/posts/program/linux%E5%86%85%E6%A0%B8/linux-kernel-data-structure/">Linuxå†…æ ¸æ•°æ®ç»“æ„</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">May 17, 2014</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 10 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="å†…æ ¸é“¾è¡¨">å†…æ ¸é“¾è¡¨
</h1><p>Linuxå†…æ ¸æœ‰ä¸€äº›åŸºæœ¬çš„æ•°æ®ç»“æ„ï¼Œè¿™äº›æ•°æ®ç»“æ„æ˜¯Linuxå®ç°çš„åŸºç¡€ï¼Œå¯¹äºé“¾è¡¨ç›¸ä¿¡å¤§å®¶éƒ½ä¸é™Œç”Ÿï¼Œä½†æ˜¯Linuxå†…æ ¸ä¸­çš„é“¾è¡¨ä¸å¹³å¸¸å¹³å¸¸æˆ‘ä»¬æ‰€ä½¿ç”¨çš„é“¾è¡¨ç•¥æœ‰ä¸åŒï¼Œç¬¬ä¸€æ¬¡é‡åˆ°æˆ–è®¸ä¼šæ„Ÿåˆ°å›°æƒ‘ã€‚</p>
<h2 id="æ¦‚è§ˆ">æ¦‚è§ˆ
</h2><p>å…ˆæ¥çœ‹ä¸€ä¸ªé“¾è¡¨çš„èŠ‚ç‚¹ï¼Œå¯¹äºä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯æ•°æ®ï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯ä¸²è”æ•°æ®çš„æŒ‡é’ˆã€‚Linuxé“¾è¡¨èŠ‚ç‚¹çš„å®šä¹‰å¦‚ä¸‹(ä»¥ä¸‹ä»£ç çš†ä¸º3.5ç‰ˆæœ¬)ï¼š</p>
<pre><code>// include/linux/types.h
struct list_head {
        struct list_head *next, *prev;
};
</code></pre>
<p>è¿™é‡Œçš„å®šä¹‰æœ‰äº›å¥‡æ€ªï¼Œå› ä¸ºä»…æœ‰å‰åèŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå¹¶æ²¡æœ‰æ•°æ®ï¼Œå°±åƒä¸€ä¸²é“¾å­ï¼Œåªæœ‰çº¿æ²¡æœ‰çº¿ä¸Šçš„ç å­ï¼Œè‚¯å®šæ˜¯æ— æ³•ä½¿ç”¨ï¼Œé‚£Linuxå†…æ ¸å¦‚ä½•æŠŠè¿™äº›â€œç å­â€é™„ç€åˆ°çº¿ä¸Šçš„å‘¢ï¼Ÿ</p>
<p>æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<pre><code>struce simple {
	int data;
	struct list_head list;
};
</code></pre>
<p>simpleç»“æ„ä½“çš„listæˆå‘˜æŒ‡å‘ä¸‹ä¸€ä¸ªæˆ–è€…ä¸Šä¸€ä¸ªsimpleçš„listï¼Œè¿™æ ·ä¾¿æŠŠèŠ‚ç‚¹ä¸²è”èµ·æ¥äº†ï¼Œdataä½œä¸ºâ€œç å­â€é™„ç€åœ¨listçº¿ä¸Šï¼Œä½†è¿™æ ·ä»ç„¶æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œlistæˆå‘˜ä»…ä»…æŒ‡å‘ä¸‹ä¸€ä¸ªsimpleçš„listæˆå‘˜ï¼Œé‚£ä»listæˆå‘˜å¦‚ä½•å¾—åˆ°simpleèŠ‚ç‚¹çš„åœ°å€å‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯æ ¹æ®listæˆå‘˜çš„åœ°å€ä»¥åŠlistæˆå‘˜åœ¨simpleçš„ä½ç½®ä¾¿å¯ä»¥è®¡ç®—å‡ºsimpleå¯¹è±¡çš„åœ°å€ï¼Œè¿™æ ·æœ‰äº›ç¹çï¼ŒLinuxæä¾›äº†ä¸€ä¸ªå®ï¼Œå¯ä»¥ç®€åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼š</p>
<pre><code>// include/linux/list.h
/**
 * list_entry - get the struct for this entry
 * @ptr:        the &amp;struct list_head pointer.
 * @type:       the type of the struct this is embedded in.
 * @member:     the name of the list_struct within the struct.
 */
#define list_entry(ptr, type, member) \
        container_of(ptr, type, member)

// include/linux/kernel.h
#define container_of(ptr, type, member) ({                      \
        const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr);    \
        (type *)( (char *)__mptr - offsetof(type,member) );})

#undef offsetof
#ifdef __compiler_offsetof
#define offsetof(TYPE,MEMBER) __compiler_offsetof(TYPE,MEMBER)
#else
#define offsetof(TYPE, MEMBER) ((size_t) &amp;((TYPE *)0)-&gt;MEMBER)
#endif
#endif /* __KERNEL__ */
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>list_entry</code>ç›´æ¥è°ƒç”¨äº†<code>container_of</code>ï¼Œ<code>container_of</code>åˆ†ä¸ºä¸¤å¥ï¼Œ<code>((type *)0)-&gt;member</code>å¯ä»¥è·å¾—memberåœ¨ç»“æ„ä½“typeä¸­çš„åç§»ï¼Œå‡è®¾æœ‰ä¸€ä¸ªç»“æ„ä½“åœ¨åœ°å€0çš„ä½ç½®ï¼Œé‚£ä¹ˆæˆå‘˜çš„åœ°å€ä¾¿æ˜¯æˆå‘˜å¯¹ç»“æ„ä½“çš„åç§»ï¼Œtypeofæ˜¯gccçš„æ‰©å±•ï¼Œç”¨äºè·å–å˜é‡çš„ç±»å‹ï¼Œ<code>offsetof(type,member)</code> è·å–memberæˆå‘˜åœ¨typeä¸­çš„åç§»ï¼Œç„¶åä½¿ç”¨memberæˆå‘˜çš„æŒ‡é’ˆptrï¼ˆå¤åˆ¶æˆ<code>__mptr</code>ï¼‰å‡å»åç§»ï¼Œå³æ˜¯ç»“æ„ä½“çš„åœ°å€ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œä»listæˆå‘˜çš„åœ°å€è·å–simpleç»“æ„çš„åœ°å€å¦‚ä¸‹ï¼š</p>
<pre><code>simple * p = list_entry(ptr, struct simple, list);
</code></pre>
<p>è¿™æ ·ä¾¿è§£å†³äº†ä»<code>list_head</code>ä¸Šè·å–é™„ç€çš„æ•°æ®çš„é—®é¢˜ã€‚æ¥ä¸‹æ¥éœ€è¦è§£å†³å¯¹é“¾è¡¨çš„å¢åˆ æ”¹æŸ¥çš„é—®é¢˜ï¼š</p>
<h2 id="åˆå§‹åŒ–é“¾è¡¨">åˆå§‹åŒ–é“¾è¡¨
</h2><p>åˆå§‹åŒ–é“¾è¡¨æœ‰ä¸¤ç§æ–¹æ³•ï¼ŒLIST_HEAD_INITå’ŒLIST_HEAD</p>
<pre><code>#define LIST_HEAD_INIT(name) { &amp;(name), &amp;(name) }

#define LIST_HEAD(name) \
        struct list_head name = LIST_HEAD_INIT(name)

static inline void INIT_LIST_HEAD(struct list_head *list)
{
        list-&gt;next = list;
        list-&gt;prev = list;
}
</code></pre>
<p>åˆ›å»ºä¸€ä¸ªæŒ‡å‘è‡ªèº«çš„èŠ‚ç‚¹ã€‚</p>
<h2 id="æ’å…¥èŠ‚ç‚¹">æ’å…¥èŠ‚ç‚¹
</h2><p>åœ¨èŠ‚ç‚¹åæ’å…¥æ–°èŠ‚ç‚¹<code>list_add_tail</code>ï¼Œå’Œåœ¨èŠ‚ç‚¹å‰æ’å…¥æ–°èŠ‚ç‚¹<code>list_add</code>ï¼š</p>
<pre><code>/**
 * list_add - add a new entry
 * @new: new entry to be added
 * @head: list head to add it after
 *
 * Insert a new entry after the specified head.
 * This is good for implementing stacks.
 */
static inline void list_add(struct list_head *new, struct list_head *head)
{
        __list_add(new, head, head-&gt;next);
}

/**     
 * list_add_tail - add a new entry
 * @new: new entry to be added
 * @head: list head to add it before
 *
 * Insert a new entry before the specified head.
 * This is useful for implementing queues.
 */
static inline void list_add_tail(struct list_head *new, struct list_head *head)
{
        __list_add(new, head-&gt;prev, head);
}
</code></pre>
<p>å…¶ä¸­ <code>__list_add</code> åªæ˜¯æ™®é€šçš„é“¾è¡¨æ“ä½œï¼Œå¹¶æ— ç‰¹åˆ«ä¹‹å¤„ï¼Œå¯å‚è§Linuxæºç æŸ¥çœ‹å®ç°ã€‚</p>
<h2 id="åˆ é™¤èŠ‚ç‚¹">åˆ é™¤èŠ‚ç‚¹
</h2><pre><code>static inline void list_del(struct list_head *entry)
{
        __list_del(entry-&gt;prev, entry-&gt;next);
        entry-&gt;next = LIST_POISON1;
        entry-&gt;prev = LIST_POISON2;
}
</code></pre>
<p><code>__list_del</code> æŠŠentryä»é“¾è¡¨ä¸­åˆ é™¤ï¼Œä¹‹åæŠŠentryé“¾è¡¨æŒ‡é’ˆå¤åˆ¶æˆéç©ºæŒ‡é’ˆï¼ˆå¦‚æœä½¿ç”¨ä¼šå‡ºç°æ®µé”™è¯¯ï¼‰</p>
<h2 id="æ£€æŸ¥æ˜¯å¦ç©ºé“¾è¡¨">æ£€æŸ¥æ˜¯å¦ç©ºé“¾è¡¨
</h2><p>åˆ¤æ–­ä¸€ä¸ªé“¾è¡¨æ˜¯å¦ä¸ºç©ºï¼Œåªéœ€è¦çœ‹å¤´èŠ‚ç‚¹æ˜¯å¦æŒ‡å‘è‡ªå·±ä¾¿å¯ï¼š</p>
<pre><code>static inline int list_empty(const struct list_head *head)
{
        return head-&gt;next == head;
}
</code></pre>
<h2 id="éå†é“¾è¡¨">éå†é“¾è¡¨
</h2><p>éå†æ˜¯è¿™å‡ ç§æ“ä½œä¸­æœ€ä¸ºå¤æ‚çš„ï¼Œæœ‰å››ä¸ªå‡½æ•°ï¼š</p>
<pre><code>#define list_for_each(pos, head) \
        for (pos = (head)-&gt;next; pos != (head); pos = pos-&gt;next)

#define list_for_each_prev(pos, head) \
        for (pos = (head)-&gt;prev; pos != (head); pos = pos-&gt;prev)

#define list_for_each_entry(pos, head, member)                          \
        for (pos = list_entry((head)-&gt;next, typeof(*pos), member);      \
             &amp;pos-&gt;member != (head);    \
             pos = list_entry(pos-&gt;member.next, typeof(*pos), member))

#define list_for_each_entry_reverse(pos, head, member)                  \
        for (pos = list_entry((head)-&gt;prev, typeof(*pos), member);      \
             &amp;pos-&gt;member != (head);    \
             pos = list_entry(pos-&gt;member.prev, typeof(*pos), member))
</code></pre>
<p><code>list_for_each</code> å’Œ <code>list_for_each_prev</code> è¾ƒä¸ºç®€å•ï¼Œä¸€ä¸ªå‘åéå†ï¼Œå¦ä¸€ä¸ªå‘å‰éå†ï¼Œ<code>list_for_each_entry</code>å’Œ<code>list_for_each_entry_reverse</code>åŠŸèƒ½ç›¸ä¼¼ï¼Œä¸è¿‡ä¸æ˜¯å¯¹<code>list_head</code>æ“ä½œï¼Œè€Œæ˜¯ç›´æ¥å¯¹ç»“æ„ä½“æ“ä½œï¼Œå¦‚æˆ‘ä»¬è¿™é‡Œçš„simpleç»“æ„ã€‚æ ¹æ®ä¹‹å‰çš„å™è¿°ä¹Ÿä¸éš¾ç†è§£å‡½æ•°å®ç°ï¼Œåªæ˜¯åœ¨<code>list_head</code>ä¸Šè°ƒç”¨äº†<code>list_entry</code>è·å–äº†å®Œæ•´ç»“æ„ã€‚</p>
<h2 id="å®ä¾‹">å®ä¾‹
</h2><p>åƒè¨€ä¸‡è¯­ä¸å¦‚ä¸€ä¸ªä¾‹å­æ¥çš„ç›´è§‚ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­è¯´æ˜ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨å†…æ ¸é“¾è¡¨ï¼š</p>
<pre><code>#include &lt;linux/list.h&gt;
#include &lt;linux/kernel.h&gt;
#include &lt;stdio.h&gt;

struct simple {
    int data;
    struct list_head list;
};

int main()
{
    int i = 0;
    struct simple * p;
    struct list_head * pos;
    LIST_HEAD(head);
    for (i = 0; i &lt; 10; i++) {
        p = (struct simple*)malloc(sizeof(struct simple));
        p-&gt;data = i * 10;
        list_add_tail(&amp;p-&gt;list, &amp;head);
    }

    list_for_each_entry(p, &amp;head, list) {
        printf(&quot;for %d\n&quot;, p-&gt;data);
    }

    while (!list_empty(&amp;head)) {
        pos = head.next;
        p = (struct simple*)list_entry(pos,
                struct simple, list);
        list_del(pos);
        printf(&quot;del %d\n&quot;, p-&gt;data);
        free(p);
    }
    return 0;
}
</code></pre>
<p>ç¼–è¯‘å‚æ•°ä¸º</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gcc -D__KERNEL__ -I/usr/src/linux-headers-3.2.0-27-generic/include/ -I/usr/src/linux-headers-3.2.0-27-generic/arch/ia64/include/ simple.c
</span></span></code></pre></div><p>å…¶ä¸­å¤´æ–‡ä»¶ä¸­éƒ½æ˜¯å†…æ ¸å‡½æ•°ï¼Œéœ€è¦å®<code>__KERNEL__</code>ï¼Œå¦åˆ™å¤§éƒ¨åˆ†å®šä¹‰ä¼šè¢«å¿½ç•¥ã€‚</p>
<h1 id="hashè¡¨">Hashè¡¨
</h1><h2 id="å®šä¹‰">å®šä¹‰
</h2><p>é“¾è¡¨è™½ç„¶æ˜¯æœ€å¸¸è§çš„æ•°æ®ç»“æ„ï¼Œä½†å®é™…ä½¿ç”¨ä¸­ï¼Œç”±äºé“¾è¡¨çš„æ£€ç´¢èƒ½åŠ›è¾ƒå·®ï¼Œæ›´å¤šçš„æ˜¯ä½œä¸ºé˜Ÿåˆ—å’Œæ ˆç»“æ„ä½¿ç”¨ï¼Œå¦‚æœéœ€è¦æŸ¥è¯¢ï¼Œæ¯”å¦‚é€šè¿‡pidæŸ¥æ‰¾è¿›ç¨‹ï¼Œé€šè¿‡æè¿°ç¬¦æŸ¥æ‰¾inodeï¼Œå°±éœ€è¦ç”¨åˆ°æ£€ç´¢æ›´å¿«çš„æ•°æ®ç»“æ„â€”â€”Hashè¡¨ã€‚
å…ˆæ¥çœ‹HashèŠ‚ç‚¹çš„å®šä¹‰ï¼š</p>
<pre><code>struct hlist_head {
	struct hlist_node *first;
};
struct hlist_node {
	struct hlist_node *next, **pprev;
};
</code></pre>
<p>å…¶ä¸­ <code>hlist_head</code> ä¸ºå¤´ç»“ç‚¹ï¼Œä¸é“¾è¡¨ä¸åŒçš„æ˜¯è¿˜éœ€è¦ä¸€ä¸ªèŠ‚ç‚¹çš„æ¦‚å¿µ <code>hlist_node</code>ï¼Œä»–ä»¬ä¹‹é—´çš„å…³ç³»å¦‚å›¾ï¼š</p>
<p>å·¦ä¾§æ˜¯å®šé•¿æ•°ç»„ï¼Œæ¯ä¸ªèŠ‚ç‚¹æ˜¯ <code>hlist_head</code> ï¼Œå…¶ä¸­firstæŒ‡å‘ <code>hlist_node</code> èŠ‚ç‚¹ï¼Œ<code>hlist_node</code>åˆç»„æˆä¸€åˆ—é“¾è¡¨ï¼Œ<code>hlist_node</code>çš„é“¾è¡¨ç»“æ„è·Ÿ <code>list_head</code>ä¸åŒä¹‹å¤„åœ¨äº <code>hlist_node</code> çš„ pprev æŒ‡å‘äº† å‰ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆåœ°å€ã€‚</p>
<h2 id="åŸºæœ¬æ“ä½œ">åŸºæœ¬æ“ä½œ
</h2><p>Hashè¡¨ä½¿ç”¨èµ·æ¥ä¹Ÿéå¸¸ç®€å•ï¼Œé¦–å…ˆé€šè¿‡hashå‡½æ•°è®¡ç®—ç›®æ ‡å€¼ï¼Œå¾—åˆ°ä¸€ä¸ªç´¢å¼•ï¼Œåœ¨<code>hlist_head</code>æ•°ç»„ä¸­æ‰¾åˆ°ç›¸åº”ä½ç½®ï¼Œå†æ’å…¥é“¾è¡¨ã€‚Hashçš„é“¾è¡¨Linuxä¹Ÿæä¾›äº†å¤šç§æ“ä½œæ–¹å¼ï¼š</p>
<pre><code>#define INIT_HLIST_HEAD(ptr) ((ptr)-&gt;first = NULL)
static inline void hlist_add_head(struct hlist_node *n, struct hlist_head *h);
static inline void hlist_add_before(struct hlist_node *n, 
		struct hlist_node *next)
static inline void hlist_add_after(struct hlist_node *n, 
		struct hlist_node *next)
static inline void hlist_move_list(struct hlist_head *old,
		struct hlist_head *new);

#define hlist_entry(ptr, type, member) container_of(ptr,type,member)
#define hlist_for_each(pos, head) \     
        for (pos = (head)-&gt;first; pos ; pos = pos-&gt;next)
#define hlist_for_each_entry(tpos, pos, head, member)                    \
        for (pos = (head)-&gt;first;                                        \
             pos &amp;&amp;                                                      \
                ({ tpos = hlist_entry(pos, typeof(*tpos), member); 1;}); \
             pos = pos-&gt;next)
</code></pre>
<ul>
<li><code>INIT_HLIST_HEAD</code> â€”â€” åˆå§‹åŒ–é“¾è¡¨ï¼›</li>
<li><code>hlist_add_head</code> â€”â€” åœ¨é“¾è¡¨å¤´æ’å…¥èŠ‚ç‚¹ï¼›</li>
<li><code>hlist_add_before</code> â€”â€” åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¹‹å‰æ’å…¥ï¼›</li>
<li><code>hlist_add_after</code> â€”â€” åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¹‹åæ’å…¥ï¼›</li>
<li><code>hlist_entry</code> â€”â€” åŒlist_entryï¼›</li>
<li><code>hlist_for_each</code> â€”â€” ç›¸å…³çš„ä¸€ç³»åˆ—å‡½æ•°è¿›è¡Œé“¾è¡¨çš„éå†ï¼Œä¸æ™®é€šåŒå‘é“¾è¡¨æ“ä½œç›¸åŒã€‚</li>
</ul>
<p>é™¤äº†Hashè¡¨ä¸­é“¾è¡¨çš„æ“ä½œï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„å…ƒç´ æ˜¯Hashå‡½æ•°ï¼ŒHashå‡½æ•°çš„å¥½åç›´æ¥å½±å“Hashè¡¨çš„æ€§èƒ½ï¼ŒHashå‡½æ•°ä¸€èˆ¬æ¥è®²è·Ÿå…·ä½“è¦å®ç°çš„ä¸šåŠ¡ç›¸å…³ï¼Œinclude/linux/jhash.hä¸‹å®ç°äº†å‡ ä¸ªä¸åŒç”¨é€”çš„Hashå‡½æ•°ï¼Œå¦å¤–ï¼ŒLinuxè¿˜ç»™å‡ºä¸€ä¸ªç®€å•çš„Hashå‡½æ•°ï¼š</p>
<pre><code>static inline u32 hash_32(u32 val, unsigned int bits)
{
        /* On some cpus multiply is faster, on others gcc will do shifts */
        u32 hash = val * GOLDEN_RATIO_PRIME_32;

        /* High bits are more random, so use them. */
        return hash &gt;&gt; (32 - bits);
}
</code></pre>
<p>è¿™ä¸ªå‡½æ•°æŠŠ32ä½æ•´æ•°Hashæˆbitsä½çš„æ•´æ•°ï¼Œå¦å¤–è¿˜æœ‰ <code>hash_64</code> ç­‰ç­‰Hashå‡½æ•°ã€‚</p>
<h2 id="å®ä¾‹-1">å®ä¾‹
</h2><p>æœ€åå†æ¥é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­çœ‹ä¸€ä¸‹Hashè¡¨çš„ä½¿ç”¨ï¼š</p>
<pre><code>#include &lt;linux/kernel.h&gt;
#include &lt;linux/types.h&gt;
#include &lt;linux/list.h&gt;
#include &lt;linux/init.h&gt;
#include &lt;linux/module.h&gt;
#include &lt;linux/slab.h&gt;
#include &lt;linux/hash.h&gt;

struct simple_hash
{
    int data;
    struct hlist_node node;
};

struct hlist_head * phash = NULL;

static int __init initialization(void)
{
    int i,k;
    struct hlist_head * phead;
    struct hlist_node * pnode;
    struct simple_hash * p;

    printk(KERN_INFO &quot; init simple start\n&quot;);

    phash = (struct hlist_head*)kmalloc(sizeof(struct hlist_head) * 0xFF, GFP_KERNEL);
    for (i = 0; i &lt; 0xFF; i++) {
        INIT_HLIST_HEAD(&amp;phash[i]);
    }
    for (i = 0; i &lt; 10; i++) {
        p = (struct simple_hash*)kmalloc(sizeof(struct simple_hash), GFP_KERNEL);
        k = i * 13;

        p-&gt;data = k;
        INIT_HLIST_NODE(&amp;p-&gt;node);

        printk(KERN_INFO &quot;insert %d\n&quot;, k);
        phead = &amp;phash[hash_32(k, 8)];
        hlist_add_head(&amp;p-&gt;node, phead);
    }
    k = 3 * 13;
    phead = &amp;phash[hash_32(k, 8)];
    printk(KERN_INFO &quot;search %d\n&quot;, k);
    hlist_for_each_entry(p, pnode, phead, node) {
        if (p-&gt;data == k) {
            printk(KERN_INFO &quot; find it\n&quot;);
        }
    }

    printk(KERN_INFO &quot;init simple end\n&quot;);
    return 0;
}

static void __exit cleanup(void)
{
    int i;
    struct hlist_head * phead = NULL;
    struct simple_hash * p = NULL;
    printk(KERN_INFO &quot;cleanup simple\n&quot;);

    if (phash == NULL) {
        return;
    }

    for (i = 0; i &lt; 0xFF; i++) {
        phead = &amp;phash[i];
        while (!hlist_empty(phead)) {
            p = hlist_entry(phead-&gt;first, struct simple_hash, node);
            printk(KERN_INFO &quot;delete %d&quot;, p-&gt;data);
            hlist_del(&amp;p-&gt;node);
            kfree(p);
        }
    }
    kfree(phead);
}

module_init(initialization);
module_exit(cleanup);

MODULE_AUTHOR(&quot;cppbreak cppbreak@gmail.com&quot;);
MODULE_DESCRIPTION(&quot;A simple linux kernel module&quot;);
MODULE_VERSION(&quot;V0.1&quot;);
MODULE_LICENSE(&quot;Dual BSD/GPL&quot;);
</code></pre>
<p>è¿™é‡Œçš„ä»£ç æ˜¯ä¸€ä¸ªç®€å•çš„Linuxå†…æ ¸ï¼Œå…³äºå¦‚ä½•å†™ä¸€ä¸ªç®€å•çš„Linuxå†…æ ¸ï¼Œå¯ä»¥å‚é˜… Linuxå­—ç¬¦è®¾å¤‡é©±åŠ¨æ¡†æ¶</p>
<h1 id="çº¢é»‘æ ‘">çº¢é»‘æ ‘
</h1><h2 id="å®šä¹‰-1">å®šä¹‰
</h2><p>Hashè¡¨è™½ç„¶æ£€ç´¢å¤æ‚åº¦åªéœ€è¦O(1)ï¼Œä½†æ˜¯æ€§èƒ½ä¾èµ–äºHashå‡½æ•°ï¼Œä¸åˆé€‚çš„Hashå‡½æ•°ä¼šå¯¼è‡´æ€§èƒ½æå…¶ä½ä¸‹ï¼Œè€Œä¸”éœ€è¦é¢„åˆ†é…Hashå¤´ç»“ç‚¹çš„ç©ºé—´ï¼Œæ‰©å±•æ€§å’Œæ€§èƒ½ç¨³å®šæ€§éƒ½æ˜¯é—®é¢˜ï¼Œæ‰€ä»¥Linuxå†…æ ¸å¦å¤–è¿˜æœ‰ä¸€å¥—å¿«é€Ÿæ’å…¥æŸ¥è¯¢çš„æ•°æ®ç»“æ„â€”â€”çº¢é»‘æ ‘ã€‚</p>
<p>çº¢é»‘æ ‘æ˜¯ä¸€ç§å¹³è¡¡äºŒå‰æ ‘ï¼ŒäºŒå‰æ ‘æŸ¥æ‰¾æ•ˆç‡æ˜¯O(logn)ï¼Œä½†å¯¹äºæŸäº›æç«¯æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåˆ†æ”¯çš„èŠ‚ç‚¹è¿œé«˜äºå¦ä¸€ä¸ªåˆ†æ”¯ï¼Œå¤„äºä¸å¹³è¡¡çŠ¶æ€ä¸‹çš„äºŒå‰æ ‘æ€§èƒ½å¾ˆå·®ï¼Œæç«¯æƒ…å†µè·Ÿé“¾è¡¨ç›¸åŒã€‚æ‰€ä»¥å‡ºç°å¾ˆå¤šä¿æŒäºŒå‰æ ‘å¹³è¡¡çš„æ–¹æ³•ï¼Œå…¶ä¸­ä¸€ç§ä¾¿æ˜¯çº¢é»‘æ ‘ï¼Œçº¢é»‘æ ‘åœ¨äºŒå‰æ ‘çš„åŸºç¡€ä¸Šåˆè§„å®šäº†ä¸€äº›è§„åˆ™ï¼š</p>
<ul>
<li>æ€§è´¨1ï¼šèŠ‚ç‚¹æ˜¯çº¢è‰²æˆ–é»‘è‰²ã€‚</li>
<li>æ€§è´¨2ï¼šæ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²ã€‚</li>
<li>æ€§è´¨3ï¼šæ¯ä¸ªå¶èŠ‚ç‚¹æ˜¯é»‘è‰²çš„ã€‚</li>
<li>æ€§è´¨4ï¼šæ¯ä¸ªçº¢è‰²èŠ‚ç‚¹çš„ä¸¤ä¸ªå­èŠ‚ç‚¹éƒ½æ˜¯é»‘è‰²ã€‚(ä»æ¯ä¸ªå¶å­åˆ°æ ¹çš„æ‰€æœ‰è·¯å¾„ä¸Šä¸èƒ½æœ‰ä¸¤ä¸ªè¿ç»­çš„çº¢è‰²èŠ‚ç‚¹)</li>
<li>æ€§è´¨5ï¼šä»ä»»ä¸€èŠ‚ç‚¹åˆ°å…¶æ¯ä¸ªå¶å­çš„æ‰€æœ‰è·¯å¾„éƒ½åŒ…å«ç›¸åŒæ•°ç›®çš„é»‘è‰²èŠ‚ç‚¹ã€‚</li>
</ul>
<p>çº¢é»‘æ ‘çš„æ€§è´¨ä¿è¯äº†ä»æ ¹èŠ‚ç‚¹åˆ°ä»»ä½•ä¸€ä¸ªå¶å­èŠ‚ç‚¹çš„é•¿åº¦éƒ½ä¸ä¼šç›¸å·®ä¸¤å€ä»¥ä¸Šï¼Œåªè¦åœ¨å¢åˆ çš„è¿‡ç¨‹ä¸­ä¿æŒçº¢é»‘æ ‘çš„æ€§è´¨ï¼Œä¹Ÿä¾¿ä¿æŒäº†æ ‘çš„å¹³è¡¡æ€§ã€‚</p>
<h2 id="å®ç°">å®ç°
</h2><p>çº¢é»‘æ ‘åœ¨å†…æ ¸ä¸­çš„å®ç°ä½äºï¼š</p>
<pre><code>linux/lib/rbtree.c
linux/include/linux/rbtree.h
</code></pre>
<p>å¤´æ–‡ä»¶ rbtree.h ä¸­æœ‰çº¢é»‘æ ‘èŠ‚ç‚¹çš„å®šä¹‰ï¼š</p>
<pre><code>struct rb_node
{
	unsigned long  rb_parent_color;
#define RB_RED          0
#define RB_BLACK        1
	struct rb_node *rb_right;
	struct rb_node *rb_left;
} __attribute__((aligned(sizeof(long))));
/* The alignment might seem pointless, but allegedly CRIS needs it */

struct rb_root
{
	struct rb_node *rb_node;
};
</code></pre>
<p>å¯ä»¥çœ‹åˆ°çº¢é»‘æ ‘åŒé“¾è¡¨ä¸€æ ·ï¼Œéƒ½æ²¡æœ‰æ•°æ®å—çš„å®šä¹‰ï¼Œå› ä¸ºCè¯­è¨€ä¸­æ²¡æœ‰æ¨¡ç‰ˆï¼Œè¿™æ ·å®ç°èƒ½ä½¿æ•°æ®ç»“æ„è·Ÿå…·ä½“çš„ä¸šåŠ¡åˆ†ç¦»ï¼Œ<code>rb_root</code> ä¸­ä»…æœ‰ä¸€ä¸ª rb_node åŸŸï¼Œrb_nodeä¸­æœ‰é¢œè‰²å’Œå·¦å³èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œéƒ½å¾ˆå®¹æ˜“ç†è§£ã€‚</p>
<h2 id="åˆå§‹åŒ–">åˆå§‹åŒ–
</h2><p>èŠ‚ç‚¹çš„åˆå§‹åŒ–æ“ä½œï¼ŒèŠ‚ç‚¹é»˜è®¤è¢«ç½®ä¸ºçº¢è‰²ï¼š</p>
<pre><code>static inline void rb_init_node(struct rb_node *rb)
{
	rb-&gt;rb_parent_color = 0;
	rb-&gt;rb_right = NULL;
	rb-&gt;rb_left = NULL;
	RB_CLEAR_NODE(rb);
}
</code></pre>
<h2 id="å¢åˆ æ“ä½œ">å¢åˆ æ“ä½œ
</h2><p>çº¢é»‘æ ‘çš„å¢åŠ åˆ é™¤æ“ä½œå¦‚ä¸‹ï¼š</p>
<pre><code>// nodeä¸ºå·²æ’å…¥çš„èŠ‚ç‚¹ï¼Œå‡½æ•°æ£€æŸ¥æ ‘çš„å¹³è¡¡æ€§å¹¶ä¿®æ­£
void rb_insert_color(struct rb_node *node, struct rb_root *root);
// åˆ é™¤èŠ‚ç‚¹
void rb_erase(struct rb_node *node, struct rb_root *root);
</code></pre>
<p>ç”±äºäºŒå‰æ ‘éœ€è¦æ¯”è¾ƒæ•°æ®åŒºåŸŸçš„å¤§å°ï¼Œè¿™é‡Œä»…ä»…æœ‰èŠ‚ç‚¹æ˜¯ä¸å¤Ÿçš„ï¼Œæ‰€ä»¥æ’å…¥æ“ä½œéœ€è¦è°ƒç”¨è€…æ¯”è¾ƒæ’å…¥ï¼Œç„¶åè°ƒç”¨<code>rb_insert_color</code>è°ƒæ•´æ ‘çš„å¹³è¡¡æ€§ï¼Œ<code>rb_erase</code>å¯ä»¥ç›´æ¥åˆ é™¤ï¼Œå¦å¤–æœç´¢æ“ä½œä¹Ÿéœ€è¦ç”¨æˆ·æ ¹æ®äºŒå‰æ ‘çš„æ€§è´¨è‡ªå·±å¤„ç†ï¼Œåœ¨å¤´æ–‡ä»¶rbtree.hå¼€å¤´çš„æ³¨é‡Šç»™äº†ä¸€ä¸ªä½¿ç”¨çš„ä¾‹å­ï¼Œè¿™é‡Œå†è¯•ç€å†™ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<h2 id="ä¾‹å­">ä¾‹å­
</h2><pre><code>#include &lt;linux/kernel.h&gt;
#include &lt;linux/types.h&gt;
#include &lt;linux/init.h&gt;
#include &lt;linux/module.h&gt;
#include &lt;linux/slab.h&gt;
#include &lt;linux/rbtree.h&gt;

struct simple
{
    int data;
    struct rb_node node;
};

struct simple * search_simple(struct rb_root * root, int data)
{
    struct simple * p;
    struct rb_node * pnode = root-&gt;rb_node;
    while (pnode)
    {
        p = rb_entry(pnode, struct simple, node);
        if (data &lt; p-&gt;data) {
            pnode = pnode-&gt;rb_left;
        } else if (data &gt; p-&gt;data){
            pnode = pnode-&gt;rb_right;
        } else {
            return p;
        }
    }
    return NULL;
}

struct simple * insert_simple(struct rb_root * root,
        int data, struct simple * new)
{
    struct simple * p = NULL;
    struct rb_node ** pnode = &amp;root-&gt;rb_node;
    struct rb_node * parent = NULL;
    while (*pnode)
    {
        parent = *pnode;
        p = rb_entry(parent, struct simple, node);
        if (data &lt; p-&gt;data) {
            pnode = &amp;(*pnode)-&gt;rb_left;
        } else if (data &gt; p-&gt;data){
            pnode = &amp;(*pnode)-&gt;rb_right;
        } else {
            return p;
        }
    }
    rb_link_node(&amp;new-&gt;node, parent, pnode);
    rb_insert_color(&amp;new-&gt;node, root);
    return p;
}

struct rb_root g_root = RB_ROOT;

static int __init initialization(void)
{
    int i;
    struct simple * p;
    for (i = 0; i &lt; 10; i++) {
        p = (struct simple *)kmalloc(sizeof (struct simple),
                GFP_KERNEL);
        p-&gt;data = i * 10;
        rb_init_node(&amp;p-&gt;node);
        insert_simple(&amp;g_root, i * 10, p);
        printk(KERN_INFO &quot;insert %d\n&quot;, i * 10);
    }
    p = search_simple(&amp;g_root, 30);
    if (p != NULL) {
        printk(KERN_INFO &quot;find it\n&quot;);
    }

    return 0;
}

static void __exit cleanup(void)
{
    struct simple * p;
    struct rb_node * pnode = rb_first(&amp;g_root);
    while (pnode != NULL) {
        p = rb_entry(pnode, struct simple, node);        
        printk(KERN_INFO &quot;delete %d\n&quot;, p-&gt;data);
        rb_erase(pnode, &amp;g_root);
        kfree(p);
        pnode = rb_first(&amp;g_root);
    }
}

module_init(initialization);
module_exit(cleanup);

MODULE_AUTHOR(&quot;cppbreak cppbreak@gmail.com&quot;);
MODULE_DESCRIPTION(&quot;A simple linux kernel module&quot;);
MODULE_VERSION(&quot;V0.1&quot;);
MODULE_LICENSE(&quot;Dual BSD/GPL&quot;);
</code></pre>
<p>ç¨‹åºç¼–è¯‘è¿è¡Œè¯·å‚è€ƒ Linuxå­—ç¬¦è®¾å¤‡é©±åŠ¨æ¡†æ¶ã€‚</p>
<h1 id="radix-tree">Radix Tree
</h1><h2 id="å®šä¹‰-2">å®šä¹‰
</h2><p>Linuxå†…æ ¸å®ç°äº†å¤§é‡çš„æ•°æ®ç»“æ„ï¼Œå…¶ä¸­æ ‘ç»“æ„é™¤äº†å‰é¢æåˆ°çš„çº¢é»‘æ ‘ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€ç§å¾ˆæœ‰æ„æ€çš„æ ‘-Radix Treeï¼Œç¿»è¯‘ä¸ºåŸºæ•°æ ‘ã€‚Radix Treeä¹Ÿæ˜¯ä¸€ç§key-valueç»“æ„ï¼Œè¦è¯´æœ€å¿«é€Ÿçš„key-valueæŸ¥æ‰¾ç»“æ„ï¼Œéæ•°ç»„è«å±ï¼Œåªéœ€ä¸€æ¬¡å®šä½ä¾¿å¯æ‰¾åˆ°ç›®æ ‡å€¼ï¼Œå…¶ç¼ºç‚¹æ˜¯éœ€è¦å ç”¨è¿‡å¤šçš„å†…å­˜ç©ºé—´ï¼Œå¦‚æœè¿ç»­çš„keyä¸­å¤§å¤šæ•°éƒ½æ˜¯ç©ºå€¼ï¼Œç©ºé—´çš„åˆ©ç”¨ç‡ä¼šéå¸¸ä½ï¼Œå¦‚ä¸€ä¸ªæ•´æ•°èŒƒå›´çš„keyï¼Œvalueå ä¸€ä¸ªå­—èŠ‚ä¹Ÿéœ€è¦4Gçš„å­˜å‚¨ï¼Œå½“keyéå¸¸ç¨€ç–çš„æƒ…å†µä¸‹ï¼Œæ— ç–‘æ˜¯ä¸€ç§æµªè´¹ï¼ŒRadix Treeçš„è§£å†³æ–¹å¼æ˜¯åˆ†çº§ï¼Œç®€å•æ¥è¯´ï¼Œå¦‚æœæŒ‰ç…§æ•´æ•°çš„å°¾æ•°åˆ†ä¸º2çº§ï¼Œç¬¬ä¸€çº§éœ€è¦10ä¸ªæŒ‡é’ˆå³å¯ï¼Œå°¾æ•°ä¸º0çš„keyæ˜ å°„åˆ°ç¬¬ä¸€ä¸ªæŒ‡é’ˆä¸Šï¼Œç¬¬ä¸€ä¸ªæŒ‡é’ˆå†æŒ‡å‘å­˜å‚¨æ•°ç»„ï¼Œè¿™æ ·å¦‚æœåªæœ‰0-4çš„keyï¼Œä¾¿å¯ä¸éœ€è¦ç»™5-9çš„æŒ‡é’ˆåˆ†é…ç©ºé—´ï¼Œå¯èŠ‚çœä¸€åŠçš„ç©ºé—´ã€‚å½“ç„¶è¿™åªæ˜¯ç®€å•çš„ä¾‹å­ï¼Œå†…æ ¸çš„Radix Treeæ›´ä¸ºç²¾ç‚¼ã€‚</p>
<h2 id="å®ç°-1">å®ç°
</h2><p>Linuxå†…æ ¸çš„æ ¹æ®Radix Treeçš„é«˜åº¦æŠŠkeyåˆ†ä¸ºè‹¥å¹²æ®µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ¯æ®µé•¿åº¦å›ºå®šä¸º<code>RADIX_TREE_MAP_SHIFT</code>ï¼Œæ ‘é«˜åº¦å¯é€šè¿‡<code>radix_tree_extend</code>æ‰©å±•ï¼Œkeyçš„æ¯ä¸€æ®µåˆ†åˆ«æŒ‡å®šäº†æ¯ä¸€å±‚çš„ä½ç½®ã€‚</p>
<p><img src="/keep/2014/0_radix-tree.png"
	
	
	
	loading="lazy"
	
		alt="Radix Tree"
	
	
></p>
<p>æ¥ä¸‹æ¥å¯ä»¥çœ‹ä¸€äº›å¤„ç†ç»†èŠ‚ï¼š</p>
<pre><code>struct radix_tree_node {
	unsigned int    height;         /* Height from the bottom */
	unsigned int    count;
	union {
		struct radix_tree_node *parent; /* Used when ascending tree */
		struct rcu_head rcu_head;       /* Used when freeing node */
	};
	void __rcu      *slots[RADIX_TREE_MAP_SIZE];
	unsigned long   tags[RADIX_TREE_MAX_TAGS][RADIX_TREE_TAG_LONGS];
};
</code></pre>
<p><code>radix_tree_node</code> æ˜¯åŸºæ•°æ ‘çš„èŠ‚ç‚¹å®šä¹‰ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„å­—æ®µæ˜¯ <code>RADIX_TREE_MAP_SIZE</code> å¤§å°çš„æ•°ç»„ slotsï¼Œå…¶ä¸­å¯ä»¥æŒ‡å‘ä¸‹ä¸€å±‚èŠ‚ç‚¹æˆ–è€…å¶å­èŠ‚ç‚¹ itemã€‚</p>
<pre><code>struct radix_tree_root {
	unsigned int            height;
	gfp_t                   gfp_mask;
	struct radix_tree_node  __rcu *rnode;
};

#define RADIX_TREE_INIT(mask)   {                                       \
	.height = 0,                                                    \
	.gfp_mask = (mask),                                             \
	.rnode = NULL,                                                  \
}

#define RADIX_TREE(name, mask) \
struct radix_tree_root name = RADIX_TREE_INIT(mask)
</code></pre>
<p><code>radix_tree_root</code> æ˜¯æ ¹èŠ‚ç‚¹ç±»å‹ï¼Œè®°å½•äº†æ•°é«˜åº¦ height å’Œç¬¬ä¸€å±‚èŠ‚ç‚¹rnodeï¼Œ<code>RADIX_TREE_INIT</code>å®å¯¹æ ¹èŠ‚ç‚¹åˆå§‹åŒ–ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹åŸºæ•°æ ‘çš„æ ¸å¿ƒï¼Œå¦‚ä½•æ’å…¥èŠ‚ç‚¹å’Œå¦‚ä½•æŸ¥æ‰¾èŠ‚ç‚¹ï¼š</p>
<pre><code>int radix_tree_insert(struct radix_tree_root *root,
				unsigned long index, void *item)
{
	/** çœç•¥ */
	/* Make sure the tree is high enough.  */
	if (index &gt; radix_tree_maxindex(root-&gt;height)) {
		error = radix_tree_extend(root, index);
		if (error)
			return error;
	}

	slot = indirect_to_ptr(root-&gt;rnode);

	height = root-&gt;height;
	shift = (height-1) * RADIX_TREE_MAP_SHIFT;

	offset = 0;                     /* uninitialised var warning */
	while (height &gt; 0) {
		if (slot == NULL) {
			/* Have to add a child node.  */
			if (!(slot = radix_tree_node_alloc(root)))
				return -ENOMEM;
			slot-&gt;height = height;
			slot-&gt;parent = node;
			if (node) {
				rcu_assign_pointer(node-&gt;slots[offset], slot);
				node-&gt;count++;
			} else
				rcu_assign_pointer(root-&gt;rnode, ptr_to_indirect(slot));
		}

		/* Go a level down */
		offset = (index &gt;&gt; shift) &amp; RADIX_TREE_MAP_MASK;
		node = slot;
		slot = node-&gt;slots[offset];
		shift -= RADIX_TREE_MAP_SHIFT;
		height--;
	}

	/** çœç•¥ */
	return 0;
}
</code></pre>
<p>ç¯‡å¹…å…³ç³»ç®€ç•¥äº†ä»£ç ï¼Œä»£ç é¦–å…ˆä½¿ç”¨ <code>radix_tree_maxindex</code> è®¡ç®—æ ‘é«˜åº¦æ˜¯å¦èƒ½å¤Ÿå­˜å‚¨ indexï¼Œä¸è¡Œå°±è°ƒç”¨ <code>radix_tree_extend</code> æ‰©å±•æ ‘é«˜åº¦ï¼Œç´§æ¥ç€æ ¹æ®keyçš„æ¯ä¸ªå­—æ®µå®šä½èŠ‚ç‚¹ï¼Œç›´åˆ°åˆ°è¾¾æ ‘å¶å­èŠ‚ç‚¹ï¼Œå¦‚æœæ ‘èŠ‚ç‚¹æœªåˆ†é…ç©ºé—´ï¼Œåˆ™è°ƒç”¨ <code>radix_tree_node_alloc</code> åˆ†é…ï¼Œæœ€åå†æŠŠ item æŒ‚æ¥åˆ°å¶å­èŠ‚ç‚¹ä¸Šï¼Œå®Œæˆæ’å…¥æ“ä½œã€‚</p>
<p>åŸºæ•°æ ‘æŸ¥æ‰¾æ“ä½œä¸ºï¼š</p>
<pre><code>static void *radix_tree_lookup_element(struct radix_tree_root *root,
			unsigned long index, int is_slot);

void *radix_tree_lookup(struct radix_tree_root *root, unsigned long index)
{
	return radix_tree_lookup_element(root, index, 0);
}
</code></pre>
<p>å…¶ä¸­ <code>radix_tree_lookup_element</code> æŸ¥æ‰¾è¿‡ç¨‹ä¸æ’å…¥æ“ä½œç±»ä¼¼ï¼Œæ¯”è¾ƒå®¹æ˜“ç†è§£ã€‚</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/linux%E5%86%85%E6%A0%B8/">Linuxå†…æ ¸</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/posts/program/linux%E5%86%85%E6%A0%B8/redis-failed-when-out-of-memory/">
        
        

        <div class="article-details">
            <h2 class="article-title">overcommit å¯¹ fork çš„å½±å“</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/posts/program/linux%E5%86%85%E6%A0%B8/linux-kernel-process-sched/">
        
        

        <div class="article-details">
            <h2 class="article-title">Linuxå†…æ ¸ç¬”è®°-è¿›ç¨‹è°ƒåº¦</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/posts/program/linux%E5%86%85%E6%A0%B8/linux-boot-protocol/">
        
        

        <div class="article-details">
            <h2 class="article-title">Linuxå†…æ ¸ç¬”è®°-å¯åŠ¨åè®®</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/posts/program/linux%E5%86%85%E6%A0%B8/linux-vfs-source/">
        
        

        <div class="article-details">
            <h2 class="article-title">Linuxå†…æ ¸ç¬”è®°-VFS</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/posts/program/linux%E5%86%85%E6%A0%B8/linux-kernel-interrupt-and-exception/">
        
        

        <div class="article-details">
            <h2 class="article-title">Linuxå†…æ ¸ç¬”è®°-ä¸­æ–­å’Œå¼‚å¸¸</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo=""
        issue-term="pathname"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2025 æ¶¸æ³½ä¹‹é±¼
    </section>
    
    <section class="powerby">
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
