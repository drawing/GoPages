<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="slab ä»‹ç» å†…å­˜åˆ†é…ä¸é‡Šæ”¾å‘æ¥æ˜¯ç¨‹åºè®¾è®¡ä¸­çš„éš¾ç‚¹ï¼Œåœ¨Cè¯­è¨€ä¸­æœ‰mallocå¯ä»¥æ–¹ä¾¿ä½¿ç”¨ï¼Œä½†è¿˜æ˜¯æœ‰æ›´å¤šçš„é’ˆå¯¹å…·ä½“ä¸šåŠ¡çš„å®ç°ã€‚å†…å­˜åˆ†é…éœ€è¦è€ƒè™‘åˆ†é…æ•ˆç‡å’Œå†…å­˜ä½¿ç”¨ç‡çš„å¹³è¡¡ï¼Œå½“ç”¨æˆ·ç”³è¯·ä¸€å—å†…å­˜ï¼Œç¨‹åºéœ€è¦åœ¨ç©ºé—²å†…å­˜ä¸­æŸ¥æ‰¾åˆé€‚çš„å†…å­˜å—è¿”å›ï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹©ä¸€ä¸ªæœ€å¿«è·å–çš„ç®—æ³•ï¼ˆfirst-fitï¼‰ï¼Œæˆ–è€…æœ€ä¼˜é€‰æ‹©ï¼ˆbest-fitï¼‰ã€‚äºŒè€…å¾€å¾€æ— æ³•ä¸¤å…¨ã€‚å¦å¤–éœ€è¦è€ƒè™‘ä¸€ä¸ªæ ¹æœ¬æ€§çš„é—®é¢˜å°±æ˜¯å†…å­˜ç¢ç‰‡ï¼Œé‡Šæ”¾å†…å­˜æ—¶å¾€å¾€ä¸ç”³è¯·é¡ºåºä¸åŒï¼Œä¼šåœ¨å†…å­˜ä¸­ç•™ä¸‹å¤§é‡çš„ç©ºæ´ï¼Œå½“æœ‰å¤§é‡ä¸è¿ç»­çš„å°å†…å­˜å³ç¢ç‰‡å‡ºç°æ—¶ï¼Œä¾¿ä¼šäº§ç”Ÿç©ºé—²å†…å­˜å¾ˆå¤šä½†æ˜¯æ— æ³•åˆ†é…å¤§å—å†…å­˜çš„æƒ…å†µã€‚å¯¹äºæ“ä½œç³»ç»Ÿï¼Œéœ€è¦é•¿æ—¶é—´è¿è¡Œï¼Œå†…å­˜ç¢ç‰‡çš„é—®é¢˜ä¾¿æ˜¾å¾—éå¸¸çªå‡ºäº†ã€‚\n">
<title>Linux å†…æ ¸ slab åˆ†é…å™¨</title>

<link rel='canonical' href='https://drawing.fancymore.com/posts/program/linux%E5%86%85%E6%A0%B8/linux-kernel-slab-allocator/'>

<link rel="stylesheet" href="/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css"><meta property='og:title' content="Linux å†…æ ¸ slab åˆ†é…å™¨">
<meta property='og:description' content="slab ä»‹ç» å†…å­˜åˆ†é…ä¸é‡Šæ”¾å‘æ¥æ˜¯ç¨‹åºè®¾è®¡ä¸­çš„éš¾ç‚¹ï¼Œåœ¨Cè¯­è¨€ä¸­æœ‰mallocå¯ä»¥æ–¹ä¾¿ä½¿ç”¨ï¼Œä½†è¿˜æ˜¯æœ‰æ›´å¤šçš„é’ˆå¯¹å…·ä½“ä¸šåŠ¡çš„å®ç°ã€‚å†…å­˜åˆ†é…éœ€è¦è€ƒè™‘åˆ†é…æ•ˆç‡å’Œå†…å­˜ä½¿ç”¨ç‡çš„å¹³è¡¡ï¼Œå½“ç”¨æˆ·ç”³è¯·ä¸€å—å†…å­˜ï¼Œç¨‹åºéœ€è¦åœ¨ç©ºé—²å†…å­˜ä¸­æŸ¥æ‰¾åˆé€‚çš„å†…å­˜å—è¿”å›ï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹©ä¸€ä¸ªæœ€å¿«è·å–çš„ç®—æ³•ï¼ˆfirst-fitï¼‰ï¼Œæˆ–è€…æœ€ä¼˜é€‰æ‹©ï¼ˆbest-fitï¼‰ã€‚äºŒè€…å¾€å¾€æ— æ³•ä¸¤å…¨ã€‚å¦å¤–éœ€è¦è€ƒè™‘ä¸€ä¸ªæ ¹æœ¬æ€§çš„é—®é¢˜å°±æ˜¯å†…å­˜ç¢ç‰‡ï¼Œé‡Šæ”¾å†…å­˜æ—¶å¾€å¾€ä¸ç”³è¯·é¡ºåºä¸åŒï¼Œä¼šåœ¨å†…å­˜ä¸­ç•™ä¸‹å¤§é‡çš„ç©ºæ´ï¼Œå½“æœ‰å¤§é‡ä¸è¿ç»­çš„å°å†…å­˜å³ç¢ç‰‡å‡ºç°æ—¶ï¼Œä¾¿ä¼šäº§ç”Ÿç©ºé—²å†…å­˜å¾ˆå¤šä½†æ˜¯æ— æ³•åˆ†é…å¤§å—å†…å­˜çš„æƒ…å†µã€‚å¯¹äºæ“ä½œç³»ç»Ÿï¼Œéœ€è¦é•¿æ—¶é—´è¿è¡Œï¼Œå†…å­˜ç¢ç‰‡çš„é—®é¢˜ä¾¿æ˜¾å¾—éå¸¸çªå‡ºäº†ã€‚\n">
<meta property='og:url' content='https://drawing.fancymore.com/posts/program/linux%E5%86%85%E6%A0%B8/linux-kernel-slab-allocator/'>
<meta property='og:site_name' content='æ¶¸æ³½ä¹‹é±¼'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts' /><meta property='article:tag' content='Linuxå†…æ ¸' /><meta property='article:published_time' content='2014-05-18T01:16:33&#43;08:00'/><meta property='article:modified_time' content='2014-05-18T01:16:33&#43;08:00'/>
<meta name="twitter:title" content="Linux å†…æ ¸ slab åˆ†é…å™¨">
<meta name="twitter:description" content="slab ä»‹ç» å†…å­˜åˆ†é…ä¸é‡Šæ”¾å‘æ¥æ˜¯ç¨‹åºè®¾è®¡ä¸­çš„éš¾ç‚¹ï¼Œåœ¨Cè¯­è¨€ä¸­æœ‰mallocå¯ä»¥æ–¹ä¾¿ä½¿ç”¨ï¼Œä½†è¿˜æ˜¯æœ‰æ›´å¤šçš„é’ˆå¯¹å…·ä½“ä¸šåŠ¡çš„å®ç°ã€‚å†…å­˜åˆ†é…éœ€è¦è€ƒè™‘åˆ†é…æ•ˆç‡å’Œå†…å­˜ä½¿ç”¨ç‡çš„å¹³è¡¡ï¼Œå½“ç”¨æˆ·ç”³è¯·ä¸€å—å†…å­˜ï¼Œç¨‹åºéœ€è¦åœ¨ç©ºé—²å†…å­˜ä¸­æŸ¥æ‰¾åˆé€‚çš„å†…å­˜å—è¿”å›ï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹©ä¸€ä¸ªæœ€å¿«è·å–çš„ç®—æ³•ï¼ˆfirst-fitï¼‰ï¼Œæˆ–è€…æœ€ä¼˜é€‰æ‹©ï¼ˆbest-fitï¼‰ã€‚äºŒè€…å¾€å¾€æ— æ³•ä¸¤å…¨ã€‚å¦å¤–éœ€è¦è€ƒè™‘ä¸€ä¸ªæ ¹æœ¬æ€§çš„é—®é¢˜å°±æ˜¯å†…å­˜ç¢ç‰‡ï¼Œé‡Šæ”¾å†…å­˜æ—¶å¾€å¾€ä¸ç”³è¯·é¡ºåºä¸åŒï¼Œä¼šåœ¨å†…å­˜ä¸­ç•™ä¸‹å¤§é‡çš„ç©ºæ´ï¼Œå½“æœ‰å¤§é‡ä¸è¿ç»­çš„å°å†…å­˜å³ç¢ç‰‡å‡ºç°æ—¶ï¼Œä¾¿ä¼šäº§ç”Ÿç©ºé—²å†…å­˜å¾ˆå¤šä½†æ˜¯æ— æ³•åˆ†é…å¤§å—å†…å­˜çš„æƒ…å†µã€‚å¯¹äºæ“ä½œç³»ç»Ÿï¼Œéœ€è¦é•¿æ—¶é—´è¿è¡Œï¼Œå†…å­˜ç¢ç‰‡çš„é—®é¢˜ä¾¿æ˜¾å¾—éå¸¸çªå‡ºäº†ã€‚\n">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/images/avatar_hu_50b065d24a9bf4d8.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ“–</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">æ¶¸æ³½ä¹‹é±¼</a></h1>
            <h2 class="site-description">æ¶¸æ³½ä¹‹é±¼ï¼ŒçŠ¹å¸Œå‡æ°´ã€‚</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/drawing/'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#ç›´è§‚è®¤è¯†">ç›´è§‚è®¤è¯†</a></li>
    <li><a href="#ç»“æ„">ç»“æ„</a></li>
    <li><a href="#ç”¨æ³•ä¾‹å­">ç”¨æ³•ä¾‹å­</a></li>
  </ul>

  <ul>
    <li><a href="#ç¬¬ä¸€éƒ¨åˆ†kmem_cache-ç»“æ„ä½“">ç¬¬ä¸€éƒ¨åˆ†ï¼škmem_cache ç»“æ„ä½“</a></li>
    <li><a href="#ç¬¬äºŒéƒ¨åˆ†">ç¬¬äºŒéƒ¨åˆ†ï¼š</a></li>
    <li><a href="#ç¬¬ä¸‰éƒ¨åˆ†">ç¬¬ä¸‰éƒ¨åˆ†ï¼š</a></li>
    <li><a href="#ç¬¬å››éƒ¨åˆ†">ç¬¬å››éƒ¨åˆ†ï¼š</a></li>
    <li><a href="#ç¬¬äº”éƒ¨åˆ†">ç¬¬äº”éƒ¨åˆ†</a></li>
    <li><a href="#ç¬¬å…­éƒ¨åˆ†">ç¬¬å…­éƒ¨åˆ†</a></li>
  </ul>

  <ul>
    <li><a href="#ä¸€æ£€æŸ¥å‚æ•°çš„åˆç†æ€§">ä¸€ã€æ£€æŸ¥å‚æ•°çš„åˆç†æ€§</a></li>
    <li><a href="#äºŒè®¡ç®—å¯¹é½">äºŒã€è®¡ç®—å¯¹é½</a></li>
    <li><a href="#ä¸‰åˆ†é…ç¼“å­˜ç»“æ„">ä¸‰ã€åˆ†é…ç¼“å­˜ç»“æ„</a></li>
    <li><a href="#å››ç¡®å®šslabå¤´çš„å­˜å‚¨ä½ç½®">å››ã€ç¡®å®šslabå¤´çš„å­˜å‚¨ä½ç½®</a></li>
    <li><a href="#äº”calculate_slab_order">äº”ã€calculate_slab_order</a></li>
    <li><a href="#å…­ç€è‰²">å…­ã€ç€è‰²</a></li>
    <li><a href="#ä¸ƒsetup_cpu_cache">ä¸ƒã€setup_cpu_cache</a></li>
    <li><a href="#å…«åŠ å…¥å…¨å±€é“¾è¡¨">å…«ã€åŠ å…¥å…¨å±€é“¾è¡¨</a></li>
  </ul>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E7%BC%96%E7%A8%8B/" >
                ç¼–ç¨‹
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/posts/program/linux%E5%86%85%E6%A0%B8/linux-kernel-slab-allocator/">Linux å†…æ ¸ slab åˆ†é…å™¨</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">May 18, 2014</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 9 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="slab-ä»‹ç»">slab ä»‹ç»
</h1><p>å†…å­˜åˆ†é…ä¸é‡Šæ”¾å‘æ¥æ˜¯ç¨‹åºè®¾è®¡ä¸­çš„éš¾ç‚¹ï¼Œåœ¨Cè¯­è¨€ä¸­æœ‰mallocå¯ä»¥æ–¹ä¾¿ä½¿ç”¨ï¼Œä½†è¿˜æ˜¯æœ‰æ›´å¤šçš„é’ˆå¯¹å…·ä½“ä¸šåŠ¡çš„å®ç°ã€‚å†…å­˜åˆ†é…éœ€è¦è€ƒè™‘åˆ†é…æ•ˆç‡å’Œå†…å­˜ä½¿ç”¨ç‡çš„å¹³è¡¡ï¼Œå½“ç”¨æˆ·ç”³è¯·ä¸€å—å†…å­˜ï¼Œç¨‹åºéœ€è¦åœ¨ç©ºé—²å†…å­˜ä¸­æŸ¥æ‰¾åˆé€‚çš„å†…å­˜å—è¿”å›ï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹©ä¸€ä¸ªæœ€å¿«è·å–çš„ç®—æ³•ï¼ˆfirst-fitï¼‰ï¼Œæˆ–è€…æœ€ä¼˜é€‰æ‹©ï¼ˆbest-fitï¼‰ã€‚äºŒè€…å¾€å¾€æ— æ³•ä¸¤å…¨ã€‚å¦å¤–éœ€è¦è€ƒè™‘ä¸€ä¸ªæ ¹æœ¬æ€§çš„é—®é¢˜å°±æ˜¯å†…å­˜ç¢ç‰‡ï¼Œé‡Šæ”¾å†…å­˜æ—¶å¾€å¾€ä¸ç”³è¯·é¡ºåºä¸åŒï¼Œä¼šåœ¨å†…å­˜ä¸­ç•™ä¸‹å¤§é‡çš„ç©ºæ´ï¼Œå½“æœ‰å¤§é‡ä¸è¿ç»­çš„å°å†…å­˜å³ç¢ç‰‡å‡ºç°æ—¶ï¼Œä¾¿ä¼šäº§ç”Ÿç©ºé—²å†…å­˜å¾ˆå¤šä½†æ˜¯æ— æ³•åˆ†é…å¤§å—å†…å­˜çš„æƒ…å†µã€‚å¯¹äºæ“ä½œç³»ç»Ÿï¼Œéœ€è¦é•¿æ—¶é—´è¿è¡Œï¼Œå†…å­˜ç¢ç‰‡çš„é—®é¢˜ä¾¿æ˜¾å¾—éå¸¸çªå‡ºäº†ã€‚</p>
<p>Linuxå†…æ ¸ä¸€ç§åˆ†é…å†…å­˜çš„æ–¹å¼æ˜¯alloc_pagesï¼Œä½¿ç”¨ä¼™ä¼´ç®—æ³•ï¼Œä½†è¿™ä¸ªåªé€‚åº”äºæŒ‰é¡µåˆ†é…ï¼Œå¦‚æœéœ€è¦å‡ ä¸ªå­—èŠ‚çš„å†…å­˜éƒ½åˆ†é…4kï¼Œæ˜¾ç„¶ä¼šæ˜¯æå¤§çš„æµªè´¹ï¼Œæ‰€ä»¥å†…æ ¸åˆæä¾›äº†ä¸€ç§å°å†…å­˜çš„åˆ†é…æ–¹å¼ï¼Œç§°ä¹‹ä¸ºslabï¼Œå¦å¤–è¿˜æœ‰ä¸¤ç§å¯é€‰çš„åˆ†é…æ–¹å¼ï¼Œslobå’Œslubï¼Œslobæ˜¯ä¸ºäº†åœ¨åµŒå…¥å¼ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œslubåœ¨ä¸€äº›å¤§å‹è®¾å¤‡ä¸­å¸slabæœ‰æ›´ä¼˜ç§€çš„æ€§èƒ½ã€‚ä½†ä½œä¸ºç¨‹åºå¼€å‘è€…æ¥è¯´ï¼Œæ— éœ€å…³å¿ƒå†…æ ¸é€‰ç”¨äº†å“ªç§åˆ†é…æ–¹å¼ï¼Œä¸‰è€…å…·æœ‰ç›¸åŒçš„æ¥å£ï¼Œè°ƒç”¨è€…å¯ä»¥å¿½ç•¥å…¶ä¸­çš„å·®åˆ«ã€‚</p>
<p>å› ä¸ºåœ¨å†…æ ¸ä¸­éœ€è¦é¢‘ç¹åˆ†é…åŒç±»å‹çš„å¯¹è±¡ï¼Œæ¯”å¦‚é¢‘ç¹åˆ†é…socketï¼Œtask_structç­‰ç»“æ„ä½“å¯¹è±¡ï¼Œslabä¸€ä¸ªæ ¸å¿ƒæ€æƒ³å°±æ˜¯ä¸€ä¸ªslabåˆ†é…å™¨åªåˆ†é…ä¸€ç§å¯¹è±¡ï¼Œè¿™æ ·åšçš„å¥½å¤„ä¾¿æ˜¯æ¯ä¸ªslabåªåˆ†é…ç­‰å¤§å°çš„å†…å­˜ï¼Œèƒ½å¤Ÿå¾ˆå¥½çš„å…¼é¡¾æ•ˆç‡å’Œå†…å­˜ç¢ç‰‡çš„é—®é¢˜ï¼Œå½“ç„¶slabæœ€ç»ˆä¹Ÿæ˜¯é€šè¿‡alloc_pagesæŒ‰é¡µåˆ†é…çš„å†…å­˜ã€‚</p>
<h2 id="ç›´è§‚è®¤è¯†">ç›´è§‚è®¤è¯†
</h2><p>å…ˆæ¥é€šè¿‡å‘½ä»¤ç›´è§‚çš„äº†è§£ä¸€ä¸‹slabçš„æƒ…å†µï¼š</p>
<pre><code>cat /proc/slabinfo
slabinfo - version: 2.1
# name                 : tunables    : slabdata   
kmalloc_dma-512        8      8    512    8    1 : tunables    0    0    0 : slabdata      1      1      0
UDPLITEv6              0      0    704   11    2 : tunables    0    0    0 : slabdata      0      0      0
UDPv6                 11     11    704   11    2 : tunables    0    0    0 : slabdata      1      1      0
...
kmalloc-8          13156  13312      8  512    1 : tunables    0    0    0 : slabdata     26     26      0
kmalloc-192          352    420    192   21    1 : tunables    0    0    0 : slabdata     20     20      0
kmalloc-96         14293  14322     96   42    1 : tunables    0    0    0 : slabdata    341    341      0
</code></pre>
<p>å¯ä»¥å¾ˆç›´è§‚çš„çœ‹åˆ°æ¯ç§å¯¹è±¡çš„slabåˆ†é…æƒ…å†µï¼Œä»åç§°ä¸éš¾çœ‹å‡ºæ¯ç§slabçš„ä½œç”¨ï¼Œä»åå­—kmalloc-8ç­‰ä¹Ÿèƒ½çŒœæµ‹å‡ºè¿™æ˜¯è°ƒç”¨kmallocæ—¶åˆ†é…çš„å†…å­˜ï¼Œå†…å­˜ä¹Ÿæ˜¯æŒ‰ç…§ä¸€å®šè§„åˆ™é€’å¢åˆ†é…ã€‚</p>
<h2 id="ç»“æ„">ç»“æ„
</h2><p>slabåˆ†é…å™¨çš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="/keep/2014/0_kernel-slab-design.gif"
	
	
	
	loading="lazy"
	
		alt="slab allocator"
	
	
></p>
<p>æ¯ç§å…·ä½“çš„å†…å­˜åˆ†é…å™¨éƒ½ç”±kmem_cacheè¡¨ç¤ºï¼Œå¤šä¸ªkmem_cacheç»„æˆåˆ†é…å™¨é“¾ï¼Œkmem_cacheåˆç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œslabs_fullè¡¨ç¤ºå·²ç»å®Œå…¨åˆ†é…å‡ºå»çš„slabï¼Œslabs_partialè¡¨ç¤ºéƒ¨åˆ†åˆ†é…ï¼Œslabs_emptyè¡¨ç¤ºæœªè¿›è¡Œåˆ†é…ã€‚å…·ä½“çš„å®ç°åŸç†åˆ†æå¯ä»¥æ”¾åˆ°æœ€åï¼Œè¿™é‡Œå¯ä»¥æŸ¥çœ‹ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ï¼š</p>
<pre><code>// å®šä¹‰ä¸€ä¸ªslabå®ä¾‹
struct struct kmem_cache * test_cache;
// åˆ›å»ºä¸€ä¸ªæ–°ç¼“å­˜
struct kmem_cache *kmem_cache_create(const char *, size_t, size_t,
                        unsigned long,
                        void (*)(void *));
// é”€æ¯ç¼“å­˜
void kmem_cache_destroy(struct kmem_cache *); 
// åˆ†é…å†…å­˜
void *kmem_cache_alloc(struct kmem_cache *, gfp_t);
// é‡Šæ”¾å†…å­˜
void kmem_cache_free(struct kmem_cache *, void *);
</code></pre>
<h2 id="ç”¨æ³•ä¾‹å­">ç”¨æ³•ä¾‹å­
</h2><p>æ¥ä¸‹æ¥å¯ä»¥å†™ä¸€æ®µä»£ç æ¥ä½“éªŒä¸€ä¸‹slabçš„ç”¨æ³•ï¼Œè¿™é‡Œåœ¨ Linuxå­—ç¬¦è®¾å¤‡æ¡†æ¶ çš„åŸºç¡€ä¸Šæ·»åŠ ä»£ç å®ç°ï¼š</p>
<pre><code>#include&lt;linux/init.h&gt; 
#include&lt;linux/module.h&gt; 
 
#include&lt;linux/fs.h&gt; 
#include&lt;linux/types.h&gt; 
#include&lt;linux/cdev.h&gt; 
#include&lt;linux/mm.h&gt; 
#include&lt;linux/sched.h&gt; 
#include&lt;asm/io.h&gt; 
#include&lt;asm/uaccess.h&gt; 
#include&lt;asm/system.h&gt; 
 
#include&lt;linux/device.h&gt; 
 
#define OBJECT_SIZE        27 
#define OBJECT_NUM        10 
dev_t devno; 
struct class * simple_class; 
static struct cdev cdev; 
 
struct kmem_cache * cppbreak_cache; 
 
struct cache_object { 
    void * object; 
    struct list_head list; 
}; 
 
LIST_HEAD(head); 
 
ssize_t simple_write(struct file * filp, 
    const char __user * buf, size_t size, loff_t * ppos) 
{ 
    char command[OBJECT_SIZE] = {}; 
    int num = 0; 
    int i = 0; 
    if (size &gt;= OBJECT_SIZE || size &lt; 3) { 
        return -EFAULT; 
    } 
    if (copy_from_user(command, buf, size)) 
        return -EFAULT; 
    command[size] = '0'; 
 
    printk(&quot;Cache name is %s\n&quot;, kmem_cache_name(cppbreak_cache)); 
    printk(&quot;Cache object size is %d\n&quot;, kmem_cache_size(cppbreak_cache)); 
 
    num = simple_strtol(command + 2, NULL, 10); 
 
    printk(&quot;command is %s, num=%d\n&quot;, command, num); 
    if (command[0] == 'i') { 
        for (i = 0; i &lt; num; i++) { 
            struct cache_object * object = (struct cache_object *)kmem_cache_alloc(cppbreak_cache, GFP_KERNEL); 
            list_add_tail(&amp;object-&gt;list, &amp;head); 
        } 
    } 
    else if (command[0] == 'd') { 
        for (i = 0; i &lt; num &amp;&amp; !list_empty(&amp;head); i++) { 
            struct cache_object * object = 
                (struct cache_object *)list_entry( 
                    head.next, 
                    struct cache_object, 
                    list); 
            list_del(&amp;object-&gt;list); 
            kmem_cache_free(cppbreak_cache, object); 
        } 
    } 
    else { 
        return -EFAULT; 
    } 
    return size; 
} 
 
int simple_open(struct inode * pnode, struct file * pfile) 
{ 
    printk(KERN_INFO &quot;open simple\n&quot;); 
    return 0; 
} 
 
int simple_release(struct inode * pnode, struct file * pfile) 
{ 
    printk(KERN_INFO &quot;close simple\n&quot;); 
    return 0; 
} 
 
static struct file_operations simple_op =  
{ 
    .owner = THIS_MODULE, 
    .write = simple_write, 
    .open = simple_open, 
    .release = simple_release, 
}; 
 
static int __init initialization(void) 
{ 
    int result; 
 
    result = alloc_chrdev_region(&amp;devno, 0, 1, &quot;simple&quot;); 
    if (result &lt; 0) 
        return result; 
 
    cdev_init(&amp;cdev, &amp;simple_op); 
    result = cdev_add(&amp;cdev, devno, 1); 
 
    simple_class = class_create(THIS_MODULE, &quot;simple&quot;); 
    device_create(simple_class, NULL, devno, NULL, &quot;simple&quot;); 
 
    printk(KERN_INFO &quot; init simple\n&quot;); 
 
    cppbreak_cache = kmem_cache_create(&quot;cppbreak&quot;, OBJECT_SIZE, 0, SLAB_HWCACHE_ALIGN, NULL); 
    if (cppbreak_cache == NULL) { 
        printk(KERN_INFO &quot; kmem_cache_create failed\n&quot;); 
        return -10; 
    } 
    printk(KERN_INFO &quot; kmem_cache_create succ\n&quot;); 
    return result; 
} 
 
static void __exit cleanup(void) 
{ 
    if (cppbreak_cache) { 
        kmem_cache_destroy(cppbreak_cache); 
        printk(KERN_INFO &quot; kmem_cache_destroy succ\n&quot;); 
    } 
    device_destroy(simple_class, devno); 
    class_destroy(simple_class); 
 
    cdev_del(&amp;cdev); 
    unregister_chrdev_region(devno, 1); 
    printk(KERN_INFO &quot; cleanup simple\n&quot;); 
} 
 
module_init(initialization); 
module_exit(cleanup); 
 
MODULE_AUTHOR(&quot;cppbreak@gmail.com&quot;); 
MODULE_DESCRIPTION(&quot;slab tester&quot;); 
MODULE_VERSION(&quot;V0.1&quot;); 
MODULE_LICENSE(&quot;Dual BSD/GPL&quot;); 
</code></pre>
<p>è¿™é‡Œçš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œmodprobe æ¨¡å—æ—¶åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ç³»ç»ŸèŠ‚ç‚¹å’Œslabåˆ†é…å™¨ï¼Œä¹‹åä¾¿å¯åœ¨<code>echo â€œi nâ€ &gt; /dev/simple</code> æ¥åˆ†é…nä¸ªobjectï¼Œ<code>echo â€œd nâ€ &gt; /dev/simple</code> æ¥é‡Šæ”¾nä¸ªobjectã€‚å…³äºå†…æ ¸é“¾è¡¨çš„åº”ç”¨ï¼Œå¯ä»¥æŸ¥çœ‹ å†…æ ¸æ•°æ®ç»“æ„-é“¾è¡¨ã€‚</p>
<p>ä½¿ç”¨modprobeåŠ è½½å†…æ ¸ä¹‹åï¼Œä¾¿å¯çœ‹åˆ° /proc/slabinfo å¢åŠ äº† <code>cppbreak_slab</code> èŠ‚ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°<code>object_size</code>ä¿¡æ¯ï¼Œä¹‹åä¾¿å¯é€šè¿‡æ·»åŠ èŠ‚ç‚¹åˆ é™¤èŠ‚ç‚¹æ¥æŸ¥çœ‹å“åº”çš„åˆ†é…æ•°å€¼å˜åŒ–ã€‚</p>
<pre><code>[root@localhost module]# insmod simple.ko
[root@localhost module]# cat /proc/slabinfo | grep cppbreak
cppbreak               0      0     32  112    1 : tunables  120   60    0 : slabdata      0      0      0
[root@localhost module]# echo &quot;i 10&quot; &gt; /dev/simple 
[root@localhost module]# cat /proc/slabinfo | grep cppbreak
cppbreak              10    112     32  112    1 : tunables  120   60    0 : slabdata      1      1      0
[root@localhost module]# echo &quot;d 10&quot; &gt; /dev/simple 
[root@localhost module]# cat /proc/slabinfo | grep cppbreak
cppbreak               5    112     32  112    1 : tunables  120   60    0 : slabdata      1      1      0
[root@localhost module]#
</code></pre>
<p>è¿™é‡Œä¾¿ä»‹ç»äº†slabçš„è°ƒç”¨æ–¹æ³•ï¼Œå…·ä½“çš„ç»†èŠ‚å’Œå®ç°è¿‡ç¨‹éœ€è¦ä¸‹ç¯‡åˆ†è§£äº†ã€‚</p>
<h1 id="slab-å®ç°">slab å®ç°
</h1><p>slab é™¤äº†ä½œä¸ºå†…å­˜åˆ†é…å™¨ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½ä¾¿æ˜¯åšCPUçš„é«˜é€Ÿç¼“å­˜ï¼Œslabä¼šæŠŠå½“å‰cpué‡Šæ”¾çš„å¯¹è±¡ä¿å­˜åœ¨å¯¹åº”cpuçš„æ•°ç»„ä¸Šï¼Œè¿™æ ·å¦‚æœä¸‹æ¬¡è¿˜æ˜¯è¿™ä¸ªcpuåˆ†é…ç›¸åŒçš„å¯¹è±¡ï¼Œç›´æ¥ä»å¯¹åº”æ•°ç»„è¿”å›ï¼Œè¿™é‡Œåˆ©ç”¨äº†cpuçš„å‘Šè¯‰ç¼“å­˜ï¼Œcpuåˆšé‡Šæ”¾çš„ç©ºé—´ä»ç„¶å­˜åœ¨äºå®ƒçš„é«˜é€Ÿç¼“å­˜ä¸­çš„æ¦‚ç‡ä¼šå¾ˆå¤§ã€‚</p>
<p>åˆ†æslabçš„å…·ä½“å®ç°ã€‚é¦–å…ˆå¯ä»¥æµè§ˆä¸€ä¸‹å…³é”®æ•°æ®ç»“æ„ kmem_cache çš„å®ç°ï¼ˆæ³¨æ„è¿™é‡Œç»“æ„ä½“çš„å®šä¹‰æœ‰ä¸‰ä¸ªåˆ†åˆ«æ˜¯slabï¼Œslubï¼Œslobçš„å®ç°ï¼Œslabçš„å®ç°ä½äºæ–‡ä»¶ include/linux/slab_def.hï¼‰</p>
<h2 id="ç¬¬ä¸€éƒ¨åˆ†kmem_cache-ç»“æ„ä½“">ç¬¬ä¸€éƒ¨åˆ†ï¼škmem_cache ç»“æ„ä½“
</h2><p>æ ¹æ®å†…æ ¸ä»£ç æ³¨é‡Šï¼Œkmem_cacheåˆ†ä¸º6ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯ Cache tunables</p>
<pre><code>struct kmem_cache {
/* 1) Cache tunables. Protected by cache_chain_mutex */
        unsigned int batchcount;
        unsigned int limit;
        unsigned int shared;

        unsigned int buffer_size;
        u32 reciprocal_buffer_size;
		...
};
</code></pre>
<p>batchcount è¡¨ç¤ºåœ¨per-CPUåˆ—è¡¨ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼Œä»ç¼“å­˜çš„slabè·å–å¯¹è±¡çš„æ•°ç›®ã€‚limitæŒ‡å®šper-CPUåˆ—è¡¨ä¸­ä¿å­˜çš„å¯¹è±¡æœ€å¤§æ•°ç›®ï¼Œå¦‚æœè¶…è¿‡è¯¥å€¼ï¼Œå†…æ ¸ä¼šå°†batchcountä¸ªå¯¹è±¡è¿”å›åˆ°slabã€‚è¿™é‡Œçš„å‚æ•°ä¾¿æ˜¯ä¸cpué«˜é€Ÿç¼“å­˜ç›¸å…³çš„æ§åˆ¶å‚æ•°ã€‚</p>
<p><code>buffer_size</code>è¡¨ç¤ºç¼“å­˜ç®¡ç†å¯¹è±¡çš„é•¿åº¦ã€‚</p>
<h2 id="ç¬¬äºŒéƒ¨åˆ†">ç¬¬äºŒéƒ¨åˆ†ï¼š
</h2><pre><code>struct kmem_cache {
		...
/* 2) touched by every alloc &amp; free from the backend */
        unsigned int flags;             /* constant flags */
        unsigned int num;               /* # of objs per slab */
		...
};
</code></pre>
<p>num æ˜¯æ¯ä¸ªslabä¸­çš„objectæ•°é‡ã€‚</p>
<h2 id="ç¬¬ä¸‰éƒ¨åˆ†">ç¬¬ä¸‰éƒ¨åˆ†ï¼š
</h2><pre><code>struct kmem_cache {
		...
/* 3) cache_grow/shrink */
        /* order of pgs per slab (2^n) */
        unsigned int gfporder;

        /* force GFP flags, e.g. GFP_DMA */
        gfp_t allocflags;

        size_t colour;                  /* cache colouring range */
        unsigned int colour_off;        /* colour offset */
        struct kmem_cache *slabp_cache;
        unsigned int slab_size;
        unsigned int dflags;            /* dynamic flags */

        /* constructor func */
        void (*ctor)(void *obj);
		...
};
</code></pre>
<p>è¿™é‡Œäºåˆ†é…ç›¸å…³çš„å‚æ•°ï¼Œä¸»è¦çš„å‚æ•°æ˜¯é¢œè‰²èŒƒå›´ã€‚</p>
<h2 id="ç¬¬å››éƒ¨åˆ†">ç¬¬å››éƒ¨åˆ†ï¼š
</h2><pre><code>struct kmem_cache {
		...
/* 4) cache creation/removal */
        const char *name;
        struct list_head list;
        int refcount;
        int object_size;
        int align;
		...
};
</code></pre>
<p>è¿™éƒ¨åˆ†å­˜å‚¨äº†ç¼“å­˜çš„åç§°å’Œç¼“å­˜çš„list_headèŠ‚ç‚¹ã€‚</p>
<h2 id="ç¬¬äº”éƒ¨åˆ†">ç¬¬äº”éƒ¨åˆ†
</h2><p>ä¸»è¦æ˜¯ç»Ÿè®¡ä¹‹ç”¨ï¼Œå¼€å¯äº†<code>CONFIG_DEBUG_SLAB</code>å®æ‰ä¼šç”Ÿæ•ˆï¼Œä¸slabåˆ†é…ç®—æ³•æ— å…³ã€‚</p>
<pre><code>struct kmem_cache {
		...
/* 5) statistics */
        unsigned long num_active;
        unsigned long num_allocations;
        unsigned long high_mark;
        unsigned long grown;
        unsigned long reaped;
        unsigned long errors;
        unsigned long max_freeable;
        unsigned long node_allocs;
        unsigned long node_frees;
        unsigned long node_overflow;
        atomic_t allochit;
        atomic_t allocmiss;
        atomic_t freehit;
        atomic_t freemiss;

        /*
         * If debugging is enabled, then the allocator can add additional
         * fields and/or padding to every object. size contains the total
         * object size including these internal fields, the following two
         * variables contain the offset to the user object and its size.
         */
        int obj_offset;
		...
};
</code></pre>
<h2 id="ç¬¬å…­éƒ¨åˆ†">ç¬¬å…­éƒ¨åˆ†
</h2><pre><code>struct kmem_cache {
		...
/* 6) per-cpu/per-node data, touched during every alloc/free */
        /*
         * We put array[] at the end of kmem_cache, because we want to size
         * this array to nr_cpu_ids slots instead of NR_CPUS
         * (see kmem_cache_init())
         * We still use [NR_CPUS] and not [1] or [0] because cache_cache
         * is statically defined, so we reserve the max number of cpus.
         */
        struct kmem_list3 **nodelists;
        struct array_cache *array[NR_CPUS];
		...
};
</code></pre>
<p>æœ€åè¿™éƒ¨åˆ†æ˜¯per-CPUç›¸å…³å˜é‡ï¼Œarrayå¾ˆå®¹æ˜“ç†è§£ï¼Œæ—¢æ˜¯æ¯ä¸ªcpuå¯¹åº”çš„æ•°ç»„ã€‚å¦å¤–ä¸€ä¸ªæˆå‘˜nodelistså­˜å‚¨äº† <code>slabs_partia</code>lï¼Œ<code>slabs_full</code>ï¼Œ<code>slabs_free</code>é“¾è¡¨ï¼Œå¹¶è®°å½•é“¾è¡¨ç©ºé—²èŠ‚ç‚¹ç­‰ä¿¡æ¯ï¼Œè¿™ä¸ªç»“æ„ä½“ä¾¿æ˜¯ç»™per-CPUæ•°ç»„æä¾›objectçš„ç¼“å­˜æ± ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ä¸€ä¸ªæŒ‡é’ˆçš„æŒ‡é’ˆï¼Œæ˜¯ <code>kmem_list3</code> çš„äºŒç»´æ•°ç»„ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªç»´åº¦æ˜¯ä¸cpuæœ€æ¥è¿‘çš„å†…å­˜å—ç´¢å¼•ã€‚</p>
<h1 id="åˆ›å»ºè¿‡ç¨‹">åˆ›å»ºè¿‡ç¨‹
</h1><p>æ¥ä¸‹æ¥çœ‹<code>kmem_cache</code>èŠ‚ç‚¹çš„åˆ›å»ºè¿‡ç¨‹ï¼Œ<code>kmem_cache_create</code> åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<h2 id="ä¸€æ£€æŸ¥å‚æ•°çš„åˆç†æ€§">ä¸€ã€æ£€æŸ¥å‚æ•°çš„åˆç†æ€§
</h2><pre><code>if (!name || in_interrupt() || (size &lt; BYTES_PER_WORD) ||             size &gt; KMALLOC_MAX_SIZE) {
        printk(KERN_ERR &quot;%s: Early error in slab %s\n&quot;, __func__,
                        name);
        BUG();
}
</code></pre>
<p>æŸ¥çœ‹åå­—æ˜¯å¦ä¸ºç©ºï¼Œåˆ†é…å¤§å°æ˜¯å¦å¤§äºåˆ†é…çš„æœ€å¤§å€¼KMALLOC_MAX_SIZEï¼Œæ˜¯å¦å°äºCPUå­—é•¿ç­‰ï¼Œä¹‹åè¿›è¡Œäº†å»é‡æ£€æµ‹ï¼Œé˜²æ­¢åˆ›å»ºç›¸åŒåç§°çš„ç¼“å­˜ã€‚</p>
<h2 id="äºŒè®¡ç®—å¯¹é½">äºŒã€è®¡ç®—å¯¹é½
</h2><pre><code>if (size &amp; (BYTES_PER_WORD - 1)) {
        size += (BYTES_PER_WORD - 1);
        size &amp;= ~(BYTES_PER_WORD - 1);
}
</code></pre>
<p>æŒ‰ç…§å¤„ç†å™¨å­—é•¿å¯¹å…¶ã€‚ä¹‹åæ ¹æ®flag çš„ARCHå‚æ•°è®¡ç®—å¯¹é½ã€‚</p>
<h2 id="ä¸‰åˆ†é…ç¼“å­˜ç»“æ„">ä¸‰ã€åˆ†é…ç¼“å­˜ç»“æ„
</h2><pre><code>cachep = kmem_cache_zalloc(&amp;cache_cache, gfp);
if (!cachep)
        goto oops;
</code></pre>
<p>cache_cache æ˜¯ç¼“å­˜çš„slabåˆ†é…å™¨ï¼Œè¿™é‡Œåˆ›å»ºå‡ºä¸€ä¸ªæ–°çš„cacheå®ä¾‹ï¼Œå­˜å…¥cachepï¼Œè¿™é‡Œå°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œä¾¿æ˜¯mem_cacheçš„åˆ›å»ºéœ€è¦è°ƒç”¨allocï¼Œä½†æ˜¯cache_cacheæ˜¯å¦‚ä½•åˆ†é…å‡ºæ¥çš„å‘¢ï¼Œè¿™é‡Œæ¶‰åŠåˆ°slabçš„åˆå§‹åŒ–é—®é¢˜ï¼Œä¹‹åå†è®¨è®ºã€‚</p>
<h2 id="å››ç¡®å®šslabå¤´çš„å­˜å‚¨ä½ç½®">å››ã€ç¡®å®šslabå¤´çš„å­˜å‚¨ä½ç½®
</h2><pre><code>if ((size &gt;= (PAGE_SIZE &gt;&gt; 3)) &amp;&amp; !slab_early_init &amp;&amp;
    !(flags &amp; SLAB_NOLEAKTRACE))
        /*
         * Size is large, assume best to place the slab management obj
         * off-slab (should allow better packing of objs).
         */
        flags |= CFLGS_OFF_SLAB;
</code></pre>
<p>å¦‚æœobjectå¤§å°å¤§äºé¡µå¸§çš„å…«åˆ†ä¹‹ä¸€ï¼Œåˆ™å°†ç®¡ç†æ•°æ®æ”¾åˆ°slabä¹‹å¤–ã€‚</p>
<h2 id="äº”calculate_slab_order">äº”ã€calculate_slab_order
</h2><p>ç°åœ¨å·²ç»ç¡®å®šç¼“å­˜å¯¹è±¡çš„sizeï¼Œç°åœ¨éœ€è¦ä¼°ç®—slabçš„é•¿åº¦ï¼Œå‡½æ•°<code>calculate_slab_order</code>é€šè¿‡å¯¹è±¡sizeï¼Œalignå’Œflagsè®¡ç®—slabåº”è¯¥ä½¿ç”¨å¤šå°‘é¡µå¸§ï¼Œå¦‚æœé¡µå¸§è¿‡å°‘åˆ™å­˜å‚¨çš„å¯¹è±¡è¿‡å°‘ï¼Œå¢åŠ åˆ†é…ç®¡ç†çš„å¼€é”€ï¼Œå¦‚æœé¡µå¸§è¿‡å¤šï¼Œåˆ™ç©ºé—´è¿‡äºæµªè´¹ã€‚</p>
<pre><code>for (gfporder = 0; gfporder
</code></pre>
<p>å‡½æ•°å¾ªç¯ä¸­gfporderä¸ºé¡µå¸§æ•°é‡ï¼Œå¯¹æŒ‡å®šçš„é¡µå¸§ï¼Œé€šè¿‡å‡½æ•°cache_estimateè®¡ç®—èƒ½å¤Ÿå­˜å‚¨çš„æ•°é‡numä»¥åŠæµªè´¹çš„ç©ºé—´remainderï¼Œè®¡ç®—çš„å…¬å¼ä¸ºï¼š PAGE_SIZE &laquo; gfporder = head + num * size + left_overã€‚
å¦‚æœå¯¹è±¡å­˜å‚¨åœ¨slabä¹‹å¤–ï¼Œåˆ™<code>headï¼ˆmgmt_sizeï¼‰</code>ä¸º0ï¼Œå¦‚æœå¯¹è±¡å­˜å‚¨äºslabä¹‹å†…ï¼Œåˆ™ <code>head = sizeof(struct slab) + num*sizeof(kmem_bufctl_t)</code>ã€‚æ¥ç€<code>calculate_slab_order</code>ä¹‹åä¾¿æ˜¯å¾ªç¯é€€å‡ºçš„å„ç§æ¡ä»¶ã€‚</p>
<h2 id="å…­ç€è‰²">å…­ã€ç€è‰²
</h2><pre><code>cachep-&gt;colour_off = cache_line_size();
/* Offset must be a multiple of the alignment. */
if (cachep-&gt;colour_off &lt; align)                 cachep-&gt;colour_off = align;
cachep-&gt;colour = left_over / cachep-&gt;colour_off;
</code></pre>
<p><code>colour_off</code> è®¡ç®—é¢œè‰²åç§»ï¼Œcolouré¢œè‰²æ•°é‡ï¼Œç´§æ¥ç€åˆå§‹åŒ–å‡½æ•°å¯¹cacheçš„å˜é‡èµ‹å€¼ã€‚</p>
<h2 id="ä¸ƒsetup_cpu_cache">ä¸ƒã€setup_cpu_cache
</h2><p>è°ƒç”¨enable_cpucacheåˆå§‹åŒ–per-CPUå˜é‡ã€‚</p>
<h2 id="å…«åŠ å…¥å…¨å±€é“¾è¡¨">å…«ã€åŠ å…¥å…¨å±€é“¾è¡¨
</h2><p>å‡½æ•°çš„æœ€ååŠ å…¥å…¨å±€é“¾è¡¨<code>cache_chain</code>ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹ç¼“å­˜åˆ†é…è¿‡ç¨‹ï¼Œ<code>kmem_cache_alloc</code>ï¼Œå‡½æ•°è°ƒç”¨<code>__cache_alloc</code> -&gt; <code>____cache_alloc</code> å®Œæˆä¸»è¦åŠŸèƒ½ï¼š</p>
<pre><code>ac = cpu_cache_get(cachep);
if (likely(ac-&gt;avail)) {
        STATS_INC_ALLOCHIT(cachep);
        ac-&gt;touched = 1;
        objp = ac-&gt;entry[--ac-&gt;avail];
}
</code></pre>
<p>å¦‚æœper-CPUç¼“å­˜èƒ½å¤Ÿä½¿ç”¨ï¼Œåˆ™ç›´æ¥ä»cpuç¼“å­˜ä¸­è¿”å›å¯¹è±¡ã€‚å¦åˆ™é€šè¿‡å‡½æ•° cache_alloc_refill ä»slabä¸­åˆ†é…ã€‚cache_alloc_refill çš„ä½œç”¨ä¸»è¦ä»slabä¸­è·å–batchcountä¸ªå¯¹è±¡æ”¾å…¥per-CPUç¼“å­˜ã€‚</p>
<p>è¿™é‡Œæ¶‰åŠåˆ°å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœå½“å‰slabç©ºé—²ç¼“å­˜ä¸è¶³ï¼Œéœ€è°ƒç”¨ cache_grow å‡½æ•°é‡æ–°åˆ†é…æ–°çš„slabèŠ‚ç‚¹ã€‚
cache_grow æ‰§è¡Œæ—¶é¦–å…ˆè®¡ç®—é¢œè‰²å€¼ï¼Œé¢œè‰²å€¼åŠ ä¸€ï¼Œå¦‚æœè¶…è¿‡æœ€å¤§å€¼ï¼Œåˆ™è¿”å›ä»0å¼€å§‹ï¼Œè¿™é‡Œçš„é¢œè‰²å€¼ä¸»è¦æ˜¯ä¸€ä¸ªåç§»ã€‚</p>
<p>slabæ‰€éœ€çš„å†…å­˜ä½¿ç”¨æ˜¯<code>kmem_getpages</code>ä»ä¼™ä¼´ç³»ç»Ÿåˆ†é…çš„ï¼Œå¦‚æœslabå¤´å­˜å‚¨åœ¨slabä¹‹å¤–ï¼Œåˆ™è°ƒç”¨ <code>alloc_slabmgmt</code>å‡½æ•°åˆ†é…æ‰€éœ€è¦çš„ç©ºé—´ã€‚</p>
<p>æœ€åå¯¹slabå¯¹è±¡åˆå§‹åŒ–ä¹‹åæ·»åŠ åˆ°nodelistsçš„freeé“¾è¡¨ä¸­ã€‚</p>
<p>åˆ†é…å®Œæ¯•å¦‚æœå¯¹è±¡å¯¹è±¡é‡Šæ”¾ï¼Œä½¿ç”¨å‡½æ•° <code>kmem_cache_free</code>ï¼Œé‡Šæ”¾è¿‡ç¨‹å¦‚æœper-CPUä¸­å°šæœ‰å‰©ä½™ä½ç½®ï¼Œè®²å¯¹è±¡æ”¾å…¥å¯¹åº”æ•°ç»„ä¸­ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™é‡Šæ”¾åˆ°å¯¹åº”çš„nodelistsä¸­ã€‚</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/linux%E5%86%85%E6%A0%B8/">Linuxå†…æ ¸</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/posts/program/linux%E5%86%85%E6%A0%B8/redis-failed-when-out-of-memory/">
        
        

        <div class="article-details">
            <h2 class="article-title">overcommit å¯¹ fork çš„å½±å“</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/posts/program/linux%E5%86%85%E6%A0%B8/linux-kernel-process-sched/">
        
        

        <div class="article-details">
            <h2 class="article-title">Linuxå†…æ ¸ç¬”è®°-è¿›ç¨‹è°ƒåº¦</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/posts/program/linux%E5%86%85%E6%A0%B8/linux-boot-protocol/">
        
        

        <div class="article-details">
            <h2 class="article-title">Linuxå†…æ ¸ç¬”è®°-å¯åŠ¨åè®®</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/posts/program/linux%E5%86%85%E6%A0%B8/linux-vfs-source/">
        
        

        <div class="article-details">
            <h2 class="article-title">Linuxå†…æ ¸ç¬”è®°-VFS</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/posts/program/linux%E5%86%85%E6%A0%B8/linux-kernel-interrupt-and-exception/">
        
        

        <div class="article-details">
            <h2 class="article-title">Linuxå†…æ ¸ç¬”è®°-ä¸­æ–­å’Œå¼‚å¸¸</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo=""
        issue-term="pathname"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2025 æ¶¸æ³½ä¹‹é±¼
    </section>
    
    <section class="powerby">
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
